<app-navbar [email]="this.auth.currentUser.email"[firstName]="this.auth.currentUser.firstName" [path]="'home'"></app-navbar>

<div [ngClass]="{ 'blurred': !isAuthorized && !auth.isAdmninistrator }">
<main class="pt-8 pb-16 lg:pt-16 lg:pb-24 bg-white ">
    <div class="flex justify-between px-4 mx-auto max-w-screen-xl ">
  
      <article class="mx-auto w-full max-w-3xl format format-sm sm:format-base lg:format-lg format-blue">
        <header class="mb-4 lg:mb-6 not-format">
          <!-- Identity / header card with gradient frame -->
          <address class="not-italic">
            <div class="rounded-3xl p-[1px] bg-gradient-to-r from-emerald-400 via-sky-400 to-indigo-400">
              <div
                class="flex items-center gap-4 rounded-[calc(theme(borderRadius.3xl)-1px)] border border-slate-200
                      bg-white/95 p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900/85">
                <!-- Avatar -->
                <div class="relative">
                  <img
                    *ngIf="employee.profilePicture === undefined"
                    class="h-20 w-20 rounded-2xl object-cover ring-1 ring-black/5 dark:ring-white/10"
                    src="../../../assets/img/user.png" alt="Employee" />
                  <img
                    *ngIf="employee.profilePicture !== undefined"
                    class="h-20 w-20 rounded-2xl object-cover ring-1 ring-black/5 dark:ring-white/10"
                    [src]="employee.profilePicture.downloadURL" alt="Employee" />
                  <!-- role mini-badge (purely visual) -->
                  <span
                    class="absolute -bottom-1 -right-1 inline-flex h-6 min-w-6 items-center justify-center rounded-full
                          bg-indigo-600 px-1 text-xs font-semibold text-white ring-2 ring-white dark:ring-slate-900">
                    {{ (employee.role || '?')[0] }}
                  </span>
                </div>

                <!-- Name + chips -->
                <div class="min-w-0 flex-1">
                  <a href="#" rel="author"
                    class="block text-xl font-semibold tracking-tight text-slate-900 dark:text-slate-100">
                    {{employee.firstName}} {{employee.middleName}} {{employee.lastName}}
                  </a>

                  <!-- mini-stats line -->
                  <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-1.5">
                    <span
                      class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs
                            ring-1 ring-purple-200 bg-purple-50 text-purple-700
                            dark:ring-purple-800 dark:bg-purple-900/30 dark:text-purple-200">
                      <!-- briefcase -->
                      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4h4a2 2 0 0 1 2 2v1h3a1 1 0 0 1 1 1v4h-8v1a1 1 0 1 1-2 0v-1H2V8a1 1 0 0 1 1-1h3V6a2 2 0 0 1 2-2zm4 3V6h-4v1h4zM2 14h8v1a2 2 0 1 0 4 0v-1h8v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-4z"/></svg>
                      Rôle : <strong class="ml-0.5">{{employee.role}}</strong>
                    </span>

                    <span
                      class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs
                            ring-1 ring-emerald-200 bg-emerald-50 text-emerald-700
                            dark:ring-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200">
                      <!-- umbrella -->
                      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a9 9 0 0 1 9 9H3a9 9 0 0 1 9-9zm1 11v6a2 2 0 1 1-4 0h2a1 1 0 1 0 2 0v-6h0z"/></svg>
                      Vacances : <strong class="ml-0.5">{{vacation}}</strong>
                    </span>

                   <span
                    class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs
                            ring-1 ring-amber-200 bg-amber-50 text-amber-700
                            dark:ring-amber-800 dark:bg-amber-900/30 dark:text-amber-200">
                  
                    <!-- spark -->
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor" [ngStyle]="{ color: perfColor }">
                      <path d="M12 2l1.9 6H20l-4.9 3.6L17 18l-5-3.6L7 18l1.9-6L4 8h6.1L12 2z"/>
                    </svg>
                    Perf. {{ preposition }} {{ time.monthFrenchNames[givenMonth-1] }} :
                    <strong class="ml-0.5" [ngStyle]="{ color: perfColor }">{{ performancePercentageMonth }}%</strong>
                  </span>

                  </div>

                 <div class="mt-2 h-1.5 w-full rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
                  <div class="h-full rounded-full transition-all"
                      [style.width.%]="performancePercentageMonth"
                      [ngStyle]="{ 'background-color': perfColor }"></div>
                </div>


                  <!-- Contract chip -->
                  <div class="mt-2">
                    <a *ngIf=" employee.contract " target="_blank" [href]="employee.contract"
                      class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs
                              ring-1 ring-sky-200 bg-sky-50 text-sky-700 hover:bg-sky-100 hover:ring-sky-300
                              dark:ring-sky-800 dark:bg-sky-900/30 dark:text-sky-200 dark:hover:bg-sky-900/40">
                      <!-- doc -->
                      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
                      Contrat-{{year}}
                    </a>
                  </div>

                  <!-- Admin actions (unchanged behavior) -->
                  <div class="mt-3 flex flex-wrap gap-2 *:text-xs">
                    <button *ngIf="this.auth.isAdmninistrator" (click)="toggleCheckVisibility()"
                      type="button"
                      class="rounded-lg bg-emerald-600 px-3 py-1.5 font-medium text-white
                            hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-300
                            dark:bg-emerald-600 dark:hover:bg-emerald-700 dark:focus:ring-emerald-800">
                      Basculer Bonus Visibilité
                    </button>

                    <button *ngIf="checkVisible==='true'" (click)="toggleCode()" type="button"
                      class="rounded-lg bg-emerald-600 px-3 py-1.5 font-medium text-white
                            hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-300
                            dark:bg-emerald-600 dark:hover:bg-emerald-700 dark:focus:ring-emerald-800">
                      Signer Bonus
                    </button>

                    <button *ngIf="this.auth.isAdmninistrator" (click)="togglePaymentCheckVisibility()" type="button"
                      class="rounded-lg bg-indigo-600 px-3 py-1.5 font-medium text-white
                            hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300
                            dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800">
                      Basculer Paiement Visibilité
                    </button>

                    <button *ngIf="paymentCheckVisible==='true'" (click)="toggleCode()" type="button"
                      class="rounded-lg bg-indigo-600 px-3 py-1.5 font-medium text-white
                            hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300
                            dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800">
                      Signer Paiement
                    </button>

                    <button *ngIf="this.auth.isAdmninistrator" (click)="toggleSetCode()" type="button"
                      class="rounded-lg bg-rose-600 px-3 py-1.5 font-medium text-white
                            hover:bg-rose-700 focus:outline-none focus:ring-4 focus:ring-rose-300
                            dark:bg-rose-600 dark:hover:bg-rose-700 dark:focus:ring-rose-800">
                      Mis A Jour Code
                    </button>

                    <!-- SMS -->
                    <button
                      *ngIf="auth.isAdmninistrator && checkVisible==='true'"
                      class="rounded-lg bg-sky-600 px-3 py-1.5 font-medium text-white hover:bg-sky-700 mt-1"
                      (click)="sendSMSCurrent('bonus')">
                      <!-- sms -->
                      <svg class="mr-1 inline h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v12H5.17L4 17.17V4z"/><path d="M6 20h12v-2H6v2z"/></svg>
                      SMS Bonus ▶︎ {{ employee.firstName }}
                    </button>

                    <button
                      *ngIf="auth.isAdmninistrator && paymentCheckVisible==='true'"
                      class="rounded-lg bg-sky-600 px-3 py-1.5 font-medium text-white hover:bg-sky-700 mt-1"
                      (click)="sendSMSCurrent('paiement')">
                      <svg class="mr-1 inline h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v12H5.17L4 17.17V4z"/><path d="M6 20h12v-2H6v2z"/></svg>
                      SMS Paiement ▶︎ {{ employee.firstName }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </address>

          <!-- Period selectors -->
          <div
            class="mt-4 flex items-center justify-center gap-4 rounded-2xl border border-slate-200 bg-white/90 p-3
                  dark:border-slate-700 dark:bg-slate-900/80">
            <div class="w-40">
              <!-- <label class="mb-1 block text-xs font-medium text-slate-500 dark:text-slate-400">Mois</label> -->
              <select id="payments" [(ngModel)]="givenMonth"
                      class="block w-full rounded-lg border border-slate-300 bg-gray-50 p-2.5 text-sm text-gray-900
                            focus:border-blue-500 focus:ring-blue-500
                            dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100"
                      (change)="retrieveEmployees()">
                <option *ngFor="let month of monthsList" [ngValue]="month">
                  {{time.monthFrenchNames[month-1]}}
                </option>
              </select>
            </div>

            <div class="w-36">
              <!-- <label class="mb-1 block text-xs font-medium text-slate-500 dark:text-slate-400">Année</label> -->
              <select id="payments" [(ngModel)]="givenYear"
                      class="block w-full rounded-lg border border-slate-300 bg-gray-50 p-2.5 text-sm text-gray-900
                            focus:border-blue-500 focus:ring-blue-500
                            dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100"
                      (change)="retrieveEmployees()">
                <option *ngFor="let year of yearsList" [ngValue]="year">{{year}}</option>
              </select>
            </div>
          </div>

          <!-- Monthly Performance gauge -->
          <div class="container mt-3 flex mx-auto flex-col md:flex-row md:justify-center">
            <div class="w-full max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl mx-auto">
              <div
                class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 p-3 shadow-sm
                      dark:border-slate-700 dark:from-slate-900 dark:to-slate-900/80">
                <plotly-plot [data]="graphMonthPerformance.data"
                            [layout]="graphMonthPerformance.layout"></plotly-plot>
              </div>
            </div>
          </div>

          <!-- Attendance calendar + legend -->
          <div class="relative overflow-x-auto mb-6 mt-4">
            <div class="container">
              <div class="mb-2 flex flex-wrap items-center gap-2 text-xs">
                <span class="inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-green-800 dark:bg-green-900/30 dark:text-green-200">● Présent</span>
                <span class="inline-flex items-center gap-1 rounded-full bg-orange-100 px-2 py-0.5 text-orange-800 dark:bg-orange-900/30 dark:text-orange-200">● Retard</span>
                <span class="inline-flex items-center gap-1 rounded-full bg-red-100 px-2 py-0.5 text-red-800 dark:bg-red-900/30 dark:text-red-200">● Absent</span>
                <span class="inline-flex items-center gap-1 rounded-full bg-yellow-100 px-2 py-0.5 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200">● Vacance</span>
                <span class="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-0.5 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200">● Vacance en cours</span>
                <span class="inline-flex items-center gap-1 rounded-full bg-slate-200 px-2 py-0.5 text-slate-700 dark:bg-slate-700 dark:text-slate-200">● Néant</span>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-white shadow-sm
                          dark:border-slate-700 dark:bg-slate-900">
                <table class="attendance-table w-full">
                  <thead class="bg-slate-50 text-slate-700 dark:bg-slate-800 dark:text-slate-300">
                    <tr>
                      <th>Dimanche</th>
                      <th>Lundi</th>
                      <th>Mardi</th>
                      <th>Mercredi</th>
                      <th>Jeudi</th>
                      <th>Vendredi</th>
                      <th>Samedi</th>
                    </tr>
                  </thead>
                  <tbody id="attendance-body"><!-- Rows generated dynamically --></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Action buttons (unchanged handlers) -->
          <div class="flex flex-wrap items-center gap-2">
            <button *ngIf="this.auth.isAdmninistrator" type="submit" (click)="toggleMakePayment()"
                    class="mt-2 rounded-full bg-green-700 px-5 py-2.5 text-sm font-medium text-white
                          hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-300
                          dark:bg-green-700 dark:hover:bg-green-800 dark:focus:ring-green-900">
              Paiement
            </button>

            <button *ngIf="true" type="submit" (click)="toggleAttendance()"
                    class="mt-2 rounded-full bg-emerald-600 px-5 py-2.5 text-sm font-medium text-white
                          hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-300
                          dark:bg-emerald-600 dark:hover:bg-emerald-700 dark:focus:ring-emerald-900">
              Présence
            </button>

            <button
              *ngIf="this.auth.isAdmin"
              type="button"
              (click)="determineAttendance()"
              [disabled]="isMarkingPresence"
              class="mt-2 inline-flex items-center gap-2 rounded-full bg-green-700 px-5 py-2.5 text-sm font-medium text-white
                    hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-300
                    disabled:cursor-not-allowed disabled:opacity-60">
              <svg *ngIf="isMarkingPresence" class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"/>
                <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-linecap="round"/>
              </svg>
              <span>
                {{
                  isMarkingPresence
                    ? (presenceStatus === 'locating'
                        ? 'Localisation en cours…'
                        : presenceStatus === 'checking'
                          ? 'Vérification du périmètre…'
                          : presenceStatus === 'saving'
                            ? 'Enregistrement…'
                            : 'Traitement…')
                    : 'Présence Employée'
                }}
              </span>
            </button>

            <button type="button"
                    (click)="warmUpGps()"
                    [disabled]="warmingUp || isMarkingPresence"
                    class="mt-2 inline-flex items-center gap-2 rounded-full bg-slate-100 px-4 py-2 text-sm font-medium text-slate-700
                          hover:bg-slate-200 focus:outline-none focus:ring-4 focus:ring-slate-300
                          disabled:cursor-not-allowed disabled:opacity-60">
              <svg *ngIf="warmingUp" class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"/>
                <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-linecap="round"/>
              </svg>
              <span>{{ warmingUp ? 'Pré-chauffage GPS (10s)…' : 'Améliorer la précision (10s)' }}</span>
            </button>
          </div>

          <!-- Presence info blocks (unchanged) -->
          <div class="w-full max-w-2xl mt-2 ml-0 sm:ml-4 space-y-2">
            <div *ngIf="geoStatus !== 'granted'" class="rounded-xl ring-1 ring-slate-200 p-3 bg-white dark:bg-slate-900">
              <h4 class="mb-1 font-semibold text-slate-900 dark:text-slate-100">Localisation du navigateur</h4>
              <p class="text-sm text-slate-600 dark:text-slate-300" *ngIf="geoStatus === 'prompt'">
                Au prochain essai, le navigateur demandera l’autorisation. Choisissez <strong>Autoriser</strong>.
              </p>
              <p class="text-sm text-amber-700 dark:text-amber-300" *ngIf="geoStatus === 'denied'">
                La localisation est <strong>bloquée</strong>. Autorisez-la dans les réglages du téléphone / navigateur puis rechargez la page.
              </p>
              <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Astuce : rapprochez-vous d’une fenêtre / sortez, activez GPS + Wi-Fi + données mobiles.</p>
            </div>

            <div *ngIf="withinRadius === true && presenceStatus === 'done'"
                class="rounded-xl bg-green-50 text-green-900 p-3 dark:bg-green-900/30 dark:text-green-200">
              ✅ Présence confirmée (dans {{ radius }} m) — {{ onTime }}.
              <div class="text-xs mt-1 opacity-80">
                Précision: ±{{ lastAccuracy }} m • Distance: {{ lastDistance }} m • Fix: {{ lastFixAt | date:'shortTime' }}
              </div>
            </div>

            <div *ngIf="withinRadius === false && (presenceStatus === 'checking' || presenceStatus === 'done')"
                class="rounded-xl bg-amber-50 text-amber-900 p-3 dark:bg-amber-900/30 dark:text-amber-200">
              ⚠️ En dehors du lieu de travail (ou précision trop faible). Réessayez près du site.
              <div class="text-xs mt-1 opacity-80">
                Précision: ±{{ lastAccuracy }} m • Distance: {{ lastDistance }} m • Fix: {{ lastFixAt | date:'shortTime' }}
              </div>
            </div>

            <div *ngIf="presenceStatus === 'error' && errorMessage"
                class="rounded-xl bg-rose-50 text-rose-900 p-3 dark:bg-rose-900/30 dark:text-rose-200">
              ❌ Erreur: {{ errorMessage }}
            </div>
          </div>

          <!-- Demande vacances -->
          <button type="submit" (click)="toggle('showRequestVacation')"
                  class="mt-3 rounded-full bg-green-700 px-5 py-2.5 text-sm font-medium text-white
                        hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-300
                        dark:bg-green-700 dark:hover:bg-green-800 dark:focus:ring-green-900">
            Demande Vacances
          </button>

          <div *ngIf="showRequestVacation" class="mb-4 mt-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm
                                                  dark:border-slate-700 dark:bg-slate-900">
            <label for="start_date" class="mb-2 block text-sm font-medium text-slate-900 dark:text-slate-100">
              Date de Prendre les vacances
            </label>
            <input [(ngModel)]="requestDate" type="date" id="first_name"
                  class="block w-full rounded-lg border border-slate-300 bg-gray-50 p-2.5 text-sm text-gray-900
                          focus:border-blue-500 focus:ring-blue-500
                          dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100"
                  placeholder="11-2-2023" required>

            <div class="mt-3 flex gap-2">
              <button type="submit" (click)="toggle('showRequestVacation')"
                      class="rounded-full bg-slate-200 px-4 py-2 text-sm font-medium text-slate-800
                            hover:bg-slate-300 focus:outline-none focus:ring-4 focus:ring-slate-300
                            dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 dark:focus:ring-slate-600">
                Annuler
              </button>
              <button type="submit" (click)="requestVacation()"
                      class="rounded-full bg-red-600 px-4 py-2 text-sm font-medium text-white
                            hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300
                            dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800">
                Soumettre
              </button>
            </div>
          </div>

          <!-- Vacances en cours -->
          <div *ngIf=" employee.attendance" class="p-4 bg-slate-50 rounded-2xl border border-slate-200 shadow-sm dark:bg-slate-900 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-3">Vacances en cours</h3>
            <ul class="space-y-3">
              <li *ngFor="let date of getVacationInProgressDates()"
                  class="flex items-center justify-between rounded-xl border bg-white p-3 shadow-sm
                        dark:border-slate-700 dark:bg-slate-800">
                <span class="font-medium text-slate-700 dark:text-slate-200">{{ date }}</span>
                <div *ngIf="this.auth.isAdmin" class="flex gap-2">
                  <button (click)="acceptVacation(date)"
                          class="rounded-lg bg-green-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-green-700">
                    Accepter
                  </button>
                  <button (click)="rejectVacation(date)"
                          class="rounded-lg bg-red-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-red-700">
                    Annuler
                  </button>
                </div>
              </li>
            </ul>
          </div>
        </header>

        <!-- Performance details table -->
        <div class="relative overflow-x-auto mb-6 shadow-sm rounded-2xl border border-slate-200 dark:border-slate-700">
          <table class="w-full text-sm text-left text-gray-600 dark:text-gray-300">
            <thead class="text-xs uppercase bg-slate-50 dark:bg-slate-800 dark:text-slate-300">
              <tr>
                <th scope="col" class="px-6 py-3 rounded-s-lg">Details De Performance</th>
                <th scope="col" class="py-3">Aujhourd'hui ({{day}})</th>
                <th scope="col" class="px-6 py-3 rounded-e-lg">
                  {{time.monthFrenchNames[givenMonth-1]}} {{givenYear}}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr class="bg-white dark:bg-slate-900">
                <th scope="row" class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap dark:text-white">
                  Points De Performance
                </th>
                <td class="px-6 py-4">{{averageToday}} / {{totalToday}}</td>
                <td class="px-6 py-4">{{averagePointsMonth}} /{{totalPointsMonth}}</td>
              </tr>
              <tr class="bg-white dark:bg-slate-900">
                <th scope="row" class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap dark:text-white">
                  Pourcentage De Performance
                </th>
                <td class="px-6 py-4">{{employee.performancePercantage}} %</td>
                <td class="px-6 py-4">{{performancePercentageMonth}}%</td>
              </tr>
            </tbody>
            <tfoot *ngIf="this.auth.isAdmninistrator">
              <tr class="font-semibold text-slate-900 dark:text-white">
                <th scope="row" class="px-6 py-3 text-base"></th>
                <td class="py-4">
                  <a (click)="generateInvoice()" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
                    Facture de Paiement
                  </a>
                </td>
                <td class="py-4">
                  <a (click)="generateInvoiceBonus()" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
                    Facture de Bonus
                  </a>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Performance chart -->
        <div class="container flex lg:block mx-auto rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
          <div class="flex flex-col w-full">
            <h1 class="text-2xl md:text-3xl m-6 text-center text-slate-900 dark:text-slate-100">Performance</h1>

            <div class="inline-flex mx-auto mb-3 rounded-lg overflow-hidden ring-1 ring-slate-200 dark:ring-slate-700">
              <button (click)="updatePerformanceGraphics(compute.week)" type="button"
                      class="px-4 py-2 text-sm font-medium text-slate-900 bg-white hover:bg-slate-50
                            focus:z-10 focus:ring-2 focus:ring-blue-700 dark:bg-slate-800 dark:text-white dark:hover:bg-slate-700">
                1S
              </button>
              <button (click)="updatePerformanceGraphics(compute.month)" type="button"
                      class="px-4 py-2 text-sm font-medium text-slate-900 bg-white hover:bg-slate-50
                            focus:z-10 focus:ring-2 focus:ring-blue-700 dark:bg-slate-800 dark:text-white dark:hover:bg-slate-700">
                1M
              </button>
              <button (click)="updatePerformanceGraphics(compute.year)" type="button"
                      class="px-4 py-2 text-sm font-medium text-slate-900 bg-white hover:bg-slate-50
                            focus:z-10 focus:ring-2 focus:ring-blue-700 dark:bg-slate-800 dark:text-white dark:hover:bg-slate-700">
                1A
              </button>
              <button (click)="updatePerformanceGraphics(maxRange)" type="button"
                      class="px-4 py-2 text-sm font-medium text-slate-900 bg-white hover:bg-slate-50
                            focus:z-10 focus:ring-2 focus:ring-blue-700 dark:bg-slate-800 dark:text-white dark:hover:bg-slate-700">
                Max
              </button>
            </div>

            <div class="px-4 pb-4">
              <plotly-plot [data]="graphPerformance.data" [layout]="graphPerformance.layout"></plotly-plot>
            </div>
          </div>
        </div>
      </article>

    </div>
</main>
</div>
<!-- Access-code prompt -->
<div *ngIf="!isAuthorized &&  !auth.isAdmninistrator && paymentCodeLoaded "
     class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-80">
  <p class="mb-4 text-gray-900 dark:text-gray-100">
    Veuillez entrer votre code pour accéder à cette page&nbsp;:
  </p>

  <input
    [(ngModel)]="code"
    (keyup.enter)="verifyCode()"
    type="text"
    class="w-full mb-4 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
    placeholder="Code"
    autofocus
  />

  <!--  primary / confirm  -->
  <button
    (click)="verifyCode()"
    class="w-full py-2 mb-2 rounded text-white font-medium
           bg-green-700 hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-300
           dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
    Valider
  </button>

  <!--  secondary / cancel  -->
  <button
    routerLink="/home"
    class="w-full py-2 rounded font-medium
           text-gray-700 border border-gray-300 hover:bg-gray-100
           focus:outline-none focus:ring-4 focus:ring-gray-300
           dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
    Annuler
  </button>

  <p
    *ngIf="errorMsg"
    class="mt-3 text-red-600 text-center dark:text-red-400"
  >
    {{ errorMsg }}
  </p>
</div>

</div>



  <!-- Main modal -->
  <div *ngIf="displayMakePayment" id="defaultModal" tabindex="-1" class="w-full max-w-md max-h-full  fixed inset-x-0 mx-auto top-36 z-50 p-4 flex pb-6">
    <div class="relative p-4 w-full max-w-2xl h-full md:h-auto">
        <!-- Modal content -->
        <div class="relative p-4 bg-white rounded-lg shadow dark:bg-gray-800 sm:p-5">
            <!-- Modal header -->
            <div class="flex justify-between items-center pb-4 mb-4 rounded-t border-b sm:mb-5 dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Paiment a {{employee.firstName}} {{employee.middleName}}  {{employee.lastName}}
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-toggle="defaultModal" (click)="toggleMakePayment()">
                    <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <div>
                <div class="grid gap-4 mb-4 sm:grid-cols-2">
                    
                    <div>
                        <label for="salaryPaid" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Montant Payer $</label>
                        <input type="text" name="salaryPaid" id="brand" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" [(ngModel)]="salaryPaid" placeholder="100" required="">
                    </div>
                   
                    
                    
                   
                </div>
                <div class="mb-4">
                    <h1 class="mb-4">Attacher l'Image de Paiement </h1>
                <input type="file" id="getFile" style="display:none" (change)="startUpload($any($event.target).files)">
                <!-- <svg class=" w-32 h-32 text-gray-400 -left-1" fill="currentColor" viewBox="0 0 24 16" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg> -->
                <img *ngIf="currentDownloadUrl===''"  class="w-20 mx-auto rounded-lg sm:rounded-none sm:rounded-l-lg " (click)="onImageClick()" src="../../../assets/img/file.png" alt="file">
                <img *ngIf="currentDownloadUrl!==''"  class="w-20 mx-auto rounded-lg sm:rounded-none sm:rounded-l-lg " (click)="onImageClick()" [src]="currentDownloadUrl" alt="file">
               
                <!-- <img class="w-72 rounded-lg sm:rounded-none sm:rounded-l-lg" src="https://flowbite.s3.amazonaws.com/blocks/marketing-ui/avatars/bonnie-green.png" alt="Bonnie Avatar"> -->
            
            </div>
            
                <div class="flex flex-row mx-auto justify-center space-x-4">
                    <button type="submit" (click)="toggleMakePayment()" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-full text-sm w-auto sm:w-auto px-5 py-2.5 text-center " >Annuler</button>
                    <button type="submit" (click)="addPayment()"  class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-full text-sm w-auto sm:w-auto px-5 py-2.5 text-center " >Ajouter</button>
                
                </div>
              
            </div>
        </div>
    </div>
</div>


<!-- ╔══════════ Reçus d’Audit (modern card) ══════════╗ -->
<div class="mt-8 container mx-auto px-4">
  <div class="mx-auto w-full max-w-2xl overflow-hidden rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 bg-white dark:bg-slate-900">
    <!-- Header -->
    <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-emerald-600 to-teal-600">
      <div class="flex items-center gap-2 text-white">
        <!-- ticket icon -->
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6a2 2 0 0 1 2-2h8l6 6v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6zm10 0v4a2 2 0 0 0 2 2h4"/></svg>
        <h5 class="text-sm sm:text-base font-semibold tracking-wide">Crédits & Transports</h5>
      </div>

      <!-- search -->
      <div class="relative">
        <svg class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-white/80" viewBox="0 0 24 24" fill="currentColor"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"/></svg>
        <input type="text"
               [(ngModel)]="auditSearch"
               placeholder="Filtrer par date…"
               class="pl-8 pr-3 py-1.5 rounded-lg text-sm bg-white/15 placeholder-white/70 text-white
                      ring-1 ring-white/40 focus:ring-2 focus:ring-white/70 outline-none" />
      </div>
    </div>

    <!-- Body -->
    <div class="p-4">
      <!-- upload (admin only) -->
      <div *ngIf="auth.isAdmin" class="mb-4 flex items-center gap-3">
        <label class="cursor-pointer inline-flex items-center gap-2 px-3 py-2 text-sm
                       font-medium rounded-lg text-white bg-emerald-600 hover:bg-emerald-700">
          <!-- camera -->
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M9 3l2 2h6a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2zM12 9a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/></svg>
          Joindre un reçu
          <input type="file" accept="image/*,application/pdf" hidden
                 (change)="auditUpload($any($event.target).files)" />
        </label>

        <input type="number" min="0" step="0.01" [(ngModel)]="auditNewAmount"
               placeholder="Montant"
               class="w-28 p-2 rounded-lg text-sm bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700
                      focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-slate-900 dark:text-slate-100" />
      </div>

      <!-- list -->
      <ul class="divide-y divide-slate-200 dark:divide-slate-700">
        <li *ngFor="let a of auditFiltered()" class="py-3 sm:py-4 hover:bg-slate-50 dark:hover:bg-slate-800/60 rounded-lg">
          <div class="flex items-center gap-4 px-1">
            <div class="flex-shrink-0">
              <div class="h-10 w-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600
                          flex items-center justify-center ring-1 ring-black/5 dark:ring-white/10">
                <span class="text-sm font-semibold text-slate-700 dark:text-slate-100">
                  {{ employee.firstName?.substring(0,2) }}
                </span>
              </div>
            </div>

            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-slate-900 dark:text-slate-100 truncate">
                {{ a.frenchDate }}
              </p>
              <p class="text-xs text-slate-500 dark:text-slate-400">Reçu</p>
            </div>

            <!-- amount -->
            <ng-container *ngIf="!auth.isAdmin; else editAmt">
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs
                           bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200
                           dark:bg-emerald-900/20 dark:text-emerald-200 dark:ring-emerald-800">
                {{ a.amount | number:'1.0-2' }} $
              </span>
            </ng-container>
            <ng-template #editAmt>
              <input type="number" min="0" step="0.01" [(ngModel)]="a.amount"
                     (blur)="auditUpdateAmount(a)"
                     class="w-24 p-1.5 text-xs rounded border
                            bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700
                            focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500
                            text-slate-900 dark:text-slate-100" />
            </ng-template>

            <a [href]="a.url" target="_blank" class="flex-shrink-0">
              <img src="../../../assets/img/validating-ticket.png"
                   class="w-11 h-11 object-cover rounded-md border border-slate-200 dark:border-slate-700 bg-white" />
            </a>

            <button *ngIf="auth.isAdmin"
                    class="ml-1 px-2.5 py-1.5 text-xs font-medium text-white rounded-lg
                           bg-blue-600 hover:bg-blue-700"
                    (click)="auditPrepareReplace(a)">
              Changer
            </button>
          </div>
        </li>
      </ul>

      <!-- hidden input for “Changer” -->
      <input type="file" #auditFileInput hidden accept="image/*,application/pdf"
             (change)="auditReplace($any($event.target).files)" />
    </div>
  </div>
</div>
<!-- ╚════════════════════════════════════════════════╝ -->


<!-- ╔══════════ Paiements (modern card) ══════════╗ -->
<div class="mt-6 container mx-auto px-4">
  <div class="mx-auto w-full max-w-2xl overflow-hidden rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 bg-white dark:bg-slate-900">
    <!-- Header -->
    <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-indigo-600 to-sky-600">
      <div class="flex items-center gap-2 text-white">
        <!-- receipt icon -->
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h12l2 3v17l-4-2-4 2-4-2-4 2V5l2-3zm4 6h8M6 10h12M6 14h12M6 18h6"/></svg>
        <h5 class="text-sm sm:text-base font-semibold tracking-wide">Paiements</h5>
      </div>

      <!-- code input + button (unchanged behavior) -->
      <div class="flex items-center">
        <label for="simple-search" class="sr-only">Chercher</label>
        <div class="relative w-48 sm:w-56">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-2.5">
            <svg class="h-4 w-4 text-white/80" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2 10a8 8 0 1 1 14.32 4.906l1.387 1.387-1.415 1.415-1.387-1.387A8 8 0 0 1 2 10z"/>
            </svg>
          </div>
          <input type="text" [(ngModel)]="code" id="simple-search"
                 class="pl-8 pr-3 py-1.5 rounded-lg text-sm bg-white/15 placeholder-white/70 text-white
                        ring-1 ring-white/40 focus:ring-2 focus:ring-white/70 outline-none w-full"
                 placeholder="Entrer Le Code..." required />
        </div>
        <button type="submit"
                class="ml-2 p-2.5 text-sm font-medium text-white bg-white/15 rounded-lg border border-white/20
                       hover:bg-white/25 focus:ring-2 focus:ring-white/60">
          <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
          </svg>
          <span class="sr-only">Chercher</span>
        </button>
      </div>
    </div>

    <!-- Body -->
    <div *ngIf="code===paymentCode" class="p-4">
      <ul role="list" class="divide-y divide-slate-200 dark:divide-slate-700">
        <li class="py-3 sm:py-4 hover:bg-slate-50 dark:hover:bg-slate-800/60 rounded-lg"
            *ngFor="let p of paymentAmounts; let i=index">
          <div class="flex items-center gap-4 px-1">
            <!-- avatar -->
            <div class="relative inline-flex items-center justify-center w-10 h-10 overflow-hidden
                        bg-slate-100 rounded-full dark:bg-slate-700 ring-1 ring-black/5 dark:ring-white/10">
              <span class="font-medium text-slate-700 dark:text-slate-100">
                {{ this.auth.currentUser.firstName?.substring(0,2) }}
              </span>
            </div>

            <!-- date -->
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-slate-900 truncate dark:text-white">
                {{ paymentDates[i] }}
              </p>
              <p class="text-xs text-slate-500 dark:text-slate-400">Virement</p>
            </div>

            <!-- amount -->
            <div class="inline-flex items-center">
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs
                           bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200
                           dark:bg-emerald-900/20 dark:text-emerald-200 dark:ring-emerald-800">
                $ {{ paymentAmounts[i] | number:'1.0-0' }}
              </span>
            </div>
          </div>

          <!-- thumbnails / actions -->
          <div class="mt-2 flex items-center justify-center gap-6">
            <!-- generated invoice / picture -->
            <a [href]="employee.paymentsPicturePath![paymentAmounts.length - 1 - i]" target="_blank"
               class="group inline-flex items-center gap-2">
              <img src="../../../assets/img/receipt.png"
                   class="w-12 h-12 object-cover rounded-md border bg-white border-slate-200 dark:border-slate-700" alt="">
              <span class="text-xs text-slate-600 dark:text-slate-300 group-hover:underline">Facture</span>
            </a>

            <!-- bank receipt -->
            <ng-container *ngIf="employee.receipts && employee.receipts[paymentAmounts.length - 1 - i]">
              <a [href]="employee.receipts[paymentAmounts.length - 1 - i]" target="_blank"
                 class="group inline-flex items-center gap-2">
                <img src="../../../assets/img/validating-ticket.png"
                     class="w-12 h-12 object-cover rounded-md border border-slate-200 dark:border-slate-700" alt="Bank Transfer Receipt" />
                <span class="text-xs text-slate-600 dark:text-slate-300 group-hover:underline">Reçu</span>
              </a>
              <button *ngIf="this.auth.isAdmin"
                      (click)="attachReceipt(paymentAmounts.length - 1 - i)"
                      class="px-2.5 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                Changer Reçu
              </button>
            </ng-container>

            <!-- attach when missing -->
            <ng-container *ngIf="!employee.receipts || !employee.receipts[paymentAmounts.length - 1 - i]">
              <button *ngIf="this.auth.isAdmin"
                      (click)="attachReceipt(paymentAmounts.length - 1 - i)"
                      class="px-2.5 py-1.5 text-xs font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700">
                Attacher Reçu
              </button>
            </ng-container>
          </div>
        </li>
      </ul>
    </div>

    <!-- hidden input for receipts -->
    <input type="file" id="receiptFileInput" style="display: none;"
           (change)="onReceiptFileSelected($any($event.target).files)" />
  </div>
</div>
<!-- ╚═══════════════════════════════════════════════╝ -->

      <div *ngIf="displayAttendance"
          class="fixed inset-0 z-50 bg-black/50 flex items-start sm:items-center justify-center p-4">
        <!-- Modal shell -->
        <div class="w-full max-w-2xl max-h-[90vh] bg-white dark:bg-gray-800 rounded-2xl shadow-xl
                    ring-1 ring-black/5 dark:ring-white/10 flex flex-col overflow-hidden">

          <!-- Header (sticky) -->
          <div class="sticky top-0 z-10 flex items-center justify-between px-4 py-3
                      border-b bg-white/95 dark:bg-gray-800/95 backdrop-blur
                      border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
              Présence — {{ frenchDate }}
            </h3>
            <button type="button"
                    class="text-gray-400 hover:text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700
                          rounded-lg p-1.5"
                    (click)="toggleAttendance()">
              <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd"></path></svg>
              <span class="sr-only">Fermer</span>
            </button>
          </div>

          <!-- Body (scrollable) -->
          <div class="px-4 sm:px-5 py-4 overflow-y-auto">
            <div class="grid gap-4 sm:grid-cols-2">

              <div class="sm:col-span-2">
                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                  Statut (calculé)
                </label>

                <div class="flex items-center gap-3">
                  <ng-container *ngIf="employee._attachmentTakenAt as t; else noPhotoYet">
                    <ng-container *ngIf="computeAttendanceFromPhoto($any(t)) as s">
                      <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-700': s === 'P',
                          'bg-orange-100 text-orange-700': s === 'L',
                          'bg-rose-200 text-rose-800': s === 'F'
                        }"
                      >
                        {{ s === 'P' ? 'OK' : s === 'L' ? 'Retard' : 'Anomalie' }}
                      </span>
                    </ng-container>
                  </ng-container>

                  <ng-template #noPhotoYet>
                    <span class="text-xs text-gray-500">
                      Ajoutez une photo prise <strong>sur le site (Fondation Gervais)</strong> pour calculer le statut…
                    </span>
                  </ng-template>

                  <span class="text-xs text-gray-500">
                    Règle : ≤ {{ todayCutoffLabel }} → Présent • &gt; {{ todayCutoffLabel }} → En retard • autre jour → Anomalie
                  </span>
                </div>

                <!-- Impact sur la paie -->
                <ng-container *ngIf="employee._attachmentTakenAt as t2">
                  <ng-container *ngIf="computeAttendanceFromPhoto($any(t2)) as s2">
                    <div
                      class="mt-3 p-4 rounded-2xl ring-1 ring-gray-200 dark:ring-gray-700
                            bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900">
                      <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2">
                          <span class="inline-flex items-center justify-center w-6 h-6 rounded-full
                                      ring-1 ring-gray-200 dark:ring-gray-700">💰</span>
                          Impact sur la paie
                        </div>
                        <div class="text-lg font-semibold"
                            [ngClass]="{
                              'text-green-600': s2 === 'P',
                              'text-orange-600': s2 === 'L',
                              'text-rose-600': s2 === 'F'
                            }">
                          {{ s2 === 'P' ? 'OK' : s2 === 'L' ? '-$1' : '-$3' }}
                        </div>
                      </div>

                      <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
                        <div class="rounded-xl px-2 py-1 text-center ring-1 ring-green-200 bg-green-50 text-green-700">
                          OK • +$0
                        </div>
                        <div class="rounded-xl px-2 py-1 text-center ring-1 ring-orange-200 bg-orange-50 text-orange-700">
                          Retard • -$1
                        </div>
                        <div class="rounded-xl px-2 py-1 text-center ring-1 ring-rose-200 bg-rose-50 text-rose-700">
                          Anomalie • -$3
                        </div>
                      </div>
                    </div>
                  </ng-container>
                </ng-container>

                <!-- Rappel lieu (avec nuance "pas de photo par un tiers") -->
                <div
                  class="mt-3 p-4 rounded-2xl ring-1 ring-blue-200 dark:ring-blue-800
                        bg-gradient-to-br from-blue-50 to-indigo-50 text-blue-900
                        dark:from-blue-900/40 dark:to-indigo-900/40 dark:text-blue-100">
                  <div class="flex items-start gap-3">
                    <span
                      class="inline-flex items-center justify-center w-6 h-6 rounded-full
                            bg-white/70 text-blue-700 ring-1 ring-blue-200
                            dark:bg-blue-800/60 dark:text-blue-100">📍</span>
                    <div class="text-xs leading-5">
                      <p>
                        <strong>Obligatoire&nbsp;:</strong> la photo doit être prise
                        <strong>sur le site</strong> <em>(Fondation Gervais)</em>.
                      </p>
                      <ul class="mt-2 grid gap-1">
                        <li class="flex items-start gap-2">
                          <span>🏷️</span>
                          <span>Hors site ⇒ <strong>Anomalie (-$3)</strong>.</span>
                        </li>
                        <li class="flex items-start gap-2">
                          <span>🚫</span>
                          <span>
                            Les photos prises par un <strong>tiers</strong> (ami/collègue) ou
                            sans votre présence réelle sont une <strong>fraude</strong> et peuvent
                            entraîner des <strong>mesures disciplinaires</strong> si constatées.
                          </span>
                        </li>
                      </ul>
                      <p class="mt-2 opacity-80">
                        La répétition peut entraîner des sanctions plus sévères.
                      </p>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            <!-- Attachment -->
            <div class="my-4 sm:col-span-2">
              <label class="block mb-4 text-sm font-medium text-gray-900 dark:text-white">
                Pièce jointe (image max 10 Mo)
              </label>

              <input
                type="file"
                accept="image/*"
                
                (change)="onAttachmentSelected(employee, $event)"
                class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer
                      bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700
                      dark:border-gray-600 dark:placeholder-gray-400"
              />

              <p *ngIf="employee._attachmentError" class="mt-2 text-sm text-red-600">
                {{ employee._attachmentError }}
              </p>

              <div *ngIf="employee._attachmentPreview" class="mt-3">
                <img *ngIf="employee._attachmentType?.startsWith('image/')"
                    [src]="employee._attachmentPreview" alt="Preview"
                    class="max-h-48 rounded-lg border" />
                <video *ngIf="employee._attachmentType?.startsWith('video/')"
                      [src]="employee._attachmentPreview" controls
                      class="w-full max-h-64 rounded-lg border"></video>

                <div class="mt-2 flex items-center gap-3">
                  <span class="text-xs text-gray-500">
                    {{ (employee._attachmentSize || 0) / (1024 * 1024) | number:'1.1-1' }} Mo
                  </span>
                  <div
                    class="mt-1 text-xs text-gray-500 flex flex-wrap items-center gap-x-2 gap-y-1"
                    *ngIf="employee._attachmentTakenAt || employee._attachmentDeviceInfo || employee._attachmentHash"
                  >
                    <span *ngIf="employee._attachmentTakenAt">
                      📅 Pris le : {{ formatKinshasa(employee._attachmentTakenAt) }}
                    </span>

                    <!-- phone (EXIF) -->
                    <span *ngIf="employee._attachmentDeviceInfo as d">
                      • 📱 {{ compactDevice(d) }}
                    </span>

                    <!-- fallback phone (UA platform) -->
                  <!-- fallback phone (UA platform) -->
                  <span *ngIf="!employee._attachmentDeviceInfo && $any(employee._attachmentUA)?.platform">
                    • 📱 {{ $any(employee._attachmentUA)?.platform }}
                  </span>


                    <!-- short hash w/ tooltip for full -->
                    <span *ngIf="employee._attachmentHash as h" [title]="h">
                      • 🔑 {{ h | slice:0:7 }}
                    </span>
                  </div>

                  <button type="button"
                          (click)="clearAttachment(employee)"
                          class="px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300
                                dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100">
                    Retirer
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer (sticky) -->
          <div class="sticky bottom-0 z-10 px-4 sm:px-5 py-3 border-t
                      bg-white/95 dark:bg-gray-800/95 backdrop-blur
                      border-gray-200 dark:border-gray-700">
            <div class="flex justify-center gap-3">
              <button type="button"
                      class="px-5 py-2.5 rounded-full text-sm font-medium
                            bg-gray-100 hover:bg-gray-200 text-gray-800
                            dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100"
                      (click)="toggleAttendance()">
                Annuler
              </button>

              <button type="button"
                      [disabled]="savingAttendance || employee._uploading || !employee._attachmentFile"
                      (click)="confirmPhotoAttendance(employee)"
                      class="inline-flex items-center gap-2 text-white bg-green-700 hover:bg-green-800
                            focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-full
                            text-sm px-5 py-2.5 disabled:opacity-60 disabled:cursor-not-allowed">
                <svg *ngIf="savingAttendance" class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"></circle>
                  <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-linecap="round"></path>
                </svg>
                <span>{{ savingAttendance ? 'Enregistrement…' : 'Confirmer' }}</span>
              </button>
            </div>
          </div>

        </div>
      </div>


    <div *ngIf="displayBonus" id="defaultModal" tabindex="-1" class="w-full max-w-md max-h-full  fixed inset-x-0 mx-auto top-10 z-50 p-4 flex pb-6">
        <div class="mt-6 grow sm:mt-8 lg:mt-0">
            
            <div class="space-y-4 rounded-lg border border-gray-100 bg-gray-50 p-6 dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                <h2 class="font-bold  "> {{employee.firstName}}  {{employee.lastName}} Bonus {{time.monthFrenchNames[lastMonth-1]}} {{year}}</h2>
              <div class="space-y-2">
                <dl *ngIf="bonusPercentage!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                  <dt class="text-base font-normal text-gray-500 dark:text-gray-400">Performance {{bonusPercentage}}%</dt>
                  <dd class="text-base font-medium  text-green-500">$ {{bonusAmount}}</dd>
                </dl>
                <div *ngIf="this.auth.isAdmninistrator">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Nkokori" required=""[(ngModel)]="bonusPercentage">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Nkokori" required=""[(ngModel)]="bonusAmount">
                                      
                </div>
  
                <dl *ngIf="bestTeamBonusAmount!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                  <dt class="text-base font-normal text-gray-500 dark:text-gray-400">Meilleure Equipe</dt>
                  <dd class="text-base font-medium text-green-500">${{bestTeamBonusAmount}}</dd>
                </dl>
                <div *ngIf="this.auth.isAdmninistrator">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Nkokori" required=""[(ngModel)]="bestTeamBonusAmount">
                        
                </div>
                <dl *ngIf="bestEmployeeBonusAmount!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                    <dt class="text-base font-normal text-gray-500 dark:text-gray-400">Meilleure Employee</dt>
                    <dd class="text-base font-medium text-green-500">${{bestEmployeeBonusAmount}}</dd>
                  </dl>
                  <div *ngIf="this.auth.isAdmninistrator">
                      <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Nkokori" required=""[(ngModel)]="bestEmployeeBonusAmount">
                          
                  </div>
                  <dl *ngIf="bestManagerBonusAmount!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                    <dt class="text-base font-normal text-gray-500 dark:text-gray-400">Meilleure Manager</dt>
                    <dd class="text-base font-medium text-green-500">${{bestManagerBonusAmount}}</dd>
                  </dl>
                  <div *ngIf="this.auth.isAdmninistrator">
                      <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Nkokori" required=""[(ngModel)]="bestManagerBonusAmount">
                          
                  </div>
                 
  
                
              </div>
  
              <dl class="flex items-center justify-between gap-4 border-t border-gray-200 pt-2 dark:border-gray-700">
                <dt class="text-base font-bold text-gray-900 dark:text-white">Total</dt>
                <dd class="text-base font-bold text-gray-900 dark:text-white">$ {{totalBonusAmount | number:'1.0-0'}}</dd>
              </dl>
              <div>
                <button (click)="toggleBonus()" type="button" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-green-600 dark:hover:bg-green-700 focus:outline-none dark:focus:ring-green-800">Annuler</button>
                <button (click)="updateEmployeeBonusInfoAndSignCheck()" type="button" class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-blue-800">Confirmer</button>
                <button *ngIf="this.auth.isAdmninistrator" (click)="updateEmployeeBonusInfo()" type="button" class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-blue-800">Mis A Jour</button>
       
              </div>
              
            </div>
         
  
            
          </div>
    </div>
   
   


    <div *ngIf="displayPayment" id="defaultModal" tabindex="-1" class="w-full max-w-md max-h-full  fixed inset-x-0 mx-auto top-10 z-50 p-4 flex pb-6">
        <div class="mt-6 grow sm:mt-8 lg:mt-0">
            
            <div class="space-y-4 rounded-lg border border-gray-100 bg-gray-50 p-6 dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                <h2 class="font-bold  "> {{employee.firstName}}  {{employee.lastName}} Paiement {{time.monthFrenchNames[lastMonth]}} {{year}}</h2>
              <div class="space-y-2">
                <dl *ngIf="paymentAmount!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                  <dt class="text-base font-normal text-gray-500 dark:text-gray-400">Paiement </dt>
                  <dd class="text-base font-medium  text-green-500">$ {{paymentAmount | number:'1.0-0'}}</dd>
                </dl>
                <dl *ngIf="paymentIncreaseYears!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                    <dt class="text-base font-normal text-gray-500 dark:text-gray-400">Expérience ({{yearsAtCompany}}) ans </dt>
                    <dd class="text-base font-medium  text-green-500">{{yearsAtCompany}} * 10 = $ {{paymentIncreaseYears | number:'1.0-0'}}</dd>
                  </dl>
                   <dl *ngIf="paymentBankFee!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                    <dt class="text-base font-normal text-gray-500 dark:text-gray-400">Frais de virement bancaire  </dt>
                    <dd class="text-base font-medium  text-green-500"> $ {{paymentBankFee | number:'1.0-0'}}</dd>
                  </dl>
                <dl *ngIf="paymentAbsent!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                    <dt class="text-base font-normal text-red-500 ">Absent </dt>
                    <dd class="text-base font-medium  text-red-500">$ -{{paymentAbsent | number:'1.0-0'}}</dd>
                  </dl>
                  <dl *ngIf="paymentNothing!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                    <dt class="text-base font-normal text-red-500 ">Néant </dt>
                    <dd class="text-base font-medium  text-red-500">$ -{{paymentNothing | number:'1.0-0'}}</dd>
                  </dl>
                   <dl *ngIf="paymentLate!==0 || this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                    <dt class="text-base font-normal text-red-500 ">Retard </dt>
                    <dd class="text-base font-medium  text-red-500">$ -{{paymentLate | number:'1.0-0'}}</dd>
                  </dl>
                  
                <div *ngIf="this.auth.isAdmninistrator">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="100" required=""[(ngModel)]="paymentAmount">
                                      
                </div>
                <div *ngIf="this.auth.isAdmninistrator">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="6" required=""[(ngModel)]="paymentIncreaseYears">
                                      
                </div>
                <div *ngIf="this.auth.isAdmninistrator">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="6" required=""[(ngModel)]="paymentBankFee">
                                      
                </div>
                <div *ngIf="this.auth.isAdmninistrator">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="6" required=""[(ngModel)]="paymentAbsent">
                                      
                </div>
                <div *ngIf="this.auth.isAdmninistrator">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="6" required=""[(ngModel)]="paymentNothing">
                                      
                </div>
                <div *ngIf="this.auth.isAdmninistrator">
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="6" required=""[(ngModel)]="paymentLate">
                                      
                </div>
                
                
            </div>
  
              <dl class="flex items-center justify-between gap-4 border-t border-gray-200 pt-2 dark:border-gray-700">
                <dt class="text-base font-bold text-gray-900 dark:text-white">Total</dt>
                <dd class="text-base font-bold text-gray-900 dark:text-white">$ {{totalPayments| number:'1.0-0'}}</dd>
              </dl>
              <div>
                <button (click)="togglePayment()" type="button" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-green-600 dark:hover:bg-green-700 focus:outline-none dark:focus:ring-green-800">Annuler</button>
                <button (click)="updateEmployeePaymentInfoAndSignCheck()" type="button" class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-blue-800">Confirmer</button>
                <button *ngIf="this.auth.isAdmninistrator" (click)="updateEmployeePaymentInfo()" type="button" class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-blue-800">Mis A Jour</button>
       
              </div>
              
            </div>
         
  
            
        </div>
    </div>
   
    

    
    <div *ngIf="displayCode" id="defaultModal" tabindex="-1" class="w-full max-w-md max-h-full  fixed inset-x-0 mx-auto top-10 z-50 p-4 flex pb-6">
        <div class="mt-6 grow sm:mt-8 lg:mt-0">
            
            <div class="space-y-4 rounded-lg border border-gray-100 bg-gray-50 p-6 dark:border-gray-700 dark:text-white dark:bg-gray-800">
                <h2 class="font-bold  "> Entrez le code</h2>
              <div class="space-y-2">
                
                <div >
                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="code" required=""[(ngModel)]="code">
                              
                </div>
  
              <div>
                <button (click)="toggleCode()" type="button" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-green-600 dark:hover:bg-green-700 focus:outline-none dark:focus:ring-green-800">Annuler</button>
                <button (click)="toggleBonusIfCodeCorrect()" type="button" class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-blue-800">Voir Paiement</button>
                
              </div>
              
            </div>
         
  
            
          </div>
                
        </div>
               

    </div>

    <div *ngIf="displaySetCode" id="defaultModal" tabindex="-1" class="w-full max-w-md max-h-full  fixed inset-x-0 mx-auto top-10 z-50 p-4 flex pb-6">
        <div class="mt-6 grow sm:mt-8 lg:mt-0">
            
            <div class="space-y-4 rounded-lg border border-gray-100 bg-gray-50 p-6 dark:border-gray-700 dark:bg-gray-800">
             
  
                <dl *ngIf="this.auth.isAdmninistrator" class="flex items-center justify-between gap-4">
                    <dt class="text-base font-normal text-gray-500 dark:text-gray-400">Mettre A Jour le code</dt>
                    <dd class="text-base font-medium  text-green-500"> {{code}}</dd>
                  </dl>
                  <div *ngIf="this.auth.isAdmninistrator">
                      <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Nkokori" required=""[(ngModel)]="code">

                                        
                  </div>
              
            
                <div>
                    <button (click)="setCode()" type="button" class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-blue-800">Mettre A Jour</button>
                    <button (click)="toggleSetCode()" type="button" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-green-600 dark:hover:bg-green-700 focus:outline-none dark:focus:ring-green-800">Annuler</button>
                </div> 
              
            </div>
         
  
            
          </div>
      
   

        </div>
   

        <div *ngIf="isLoading" class="fixed inset-0 flex items-center justify-center z-50 bg-opacity-50 bg-gray-800">
            <div role="status" class="flex flex-col items-center">
              <svg aria-hidden="true" class="w-12 h-12 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
              </svg>
              <span class="sr-only">Chargement...</span>
              <div class="mt-2 text-white">Traitement de votre demande...</div>
            </div>
          </div>
    




<!-- Attachment viewer -->
<div *ngIf="attachmentViewer.open"
     class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-3xl">
    <div class="flex items-center justify-between px-4 py-3 border-b dark:border-gray-700">
    <h4 class="font-semibold text-gray-900 dark:text-gray-100">
        Pièce jointe — {{ attachmentViewer.dateLabel }}
        <span *ngIf="attachmentViewer.takenAt"
              class="ml-3 text-xs font-normal text-gray-500 dark:text-gray-300">
         • Pris le : {{ formatKinshasa(attachmentViewer.takenAt) }}
         <span class="ml-1 text-xs text-gray-500">(heure de Kinshasa)</span>
          <ng-container *ngIf="attachmentViewer.takenAtSource === 'storageUploadedAt'">
            (date de téléversement)
          </ng-container>
          <ng-container *ngIf="attachmentViewer.takenAtSource === 'fileLastModified'">
            (date du fichier)
          </ng-container>

        </span>
        <!-- add these: -->
        <span *ngIf="attachmentViewer.deviceLabel" class="ml-2 text-xs text-gray-500 dark:text-gray-300">
          • 📱 {{ attachmentViewer.deviceLabel }}
        </span>
        <span *ngIf="attachmentViewer.photoHash" class="ml-2 text-[10px] text-gray-500 dark:text-gray-300 opacity-80" [title]="attachmentViewer.photoHash">
          • 🔑 {{ attachmentViewer.photoHash | slice:0:7 }}
        </span>
      </h4>

      <button (click)="closeAttachmentViewer()"
              class="text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white">
        ✕
      </button>
    </div>

    <div class="p-4">
      <img *ngIf="attachmentViewer.kind === 'image'"
           [src]="attachmentViewer.url"
           class="w-full max-h-[70vh] object-contain rounded-lg border dark:border-gray-700" />

      <video *ngIf="attachmentViewer.kind === 'video'"
             [src]="attachmentViewer.url"
             controls
             class="w-full max-h-[70vh] rounded-lg border dark:border-gray-700"></video>
    </div>

    <div class="px-4 pb-4">
      <a [href]="attachmentViewer.url" target="_blank"
         class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-green-700 rounded-lg hover:bg-green-800">
        Ouvrir dans un nouvel onglet
      </a>
    </div>
  </div>
</div>



<!-- ───────────────── Attendance State Picker (Admin) ───────────────── -->
<div *ngIf="showStatePickerModal"
     class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 overflow-hidden">
    <!-- Header -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Choisir l’état — {{ friendlyFromKey(statePickerKey) }}
      </h3>
      <button class="text-gray-400 hover:text-gray-700 dark:hover:text-white rounded-lg p-1.5"
              (click)="closeStatePicker()"
              aria-label="Fermer">
        ✕
      </button>
    </div>

    <!-- Body -->
    <div class="px-4 py-4 space-y-3">
      <div class="grid grid-cols-2 gap-2">
            <button
            *ngFor="let s of pickerStates"
            type="button"
            (click)="selectedState = s.code"
            class="w-full rounded-xl px-3 py-2 text-sm text-left ring-1 transition hover:shadow text-gray-900"
            [ngClass]="{
              'bg-green-50 ring-green-300':  selectedState === 'P'  && s.code === 'P',
              'bg-red-50 ring-red-300':      selectedState === 'A'  && s.code === 'A',
              'bg-orange-50 ring-orange-300': selectedState === 'L' && s.code === 'L',
              'bg-yellow-50 ring-yellow-300': selectedState === 'V' && s.code === 'V',
              'bg-blue-50 ring-blue-300':    selectedState === 'VP' && s.code === 'VP',
              'bg-gray-100 ring-gray-300':   (selectedState === '' && s.code === '') || (selectedState === 'N' && s.code === 'N'),
             
              'dark:text-gray-900': selectedState === s.code,
              'dark:text-gray-100': selectedState !== s.code
            }"
          >
            <div class="font-semibold">{{ s.label }}</div>
            <div *ngIf="s.hint" class="text-xs opacity-80">{{ s.hint }}</div>
          </button>


      </div>

      <div class="text-xs text-gray-500 dark:text-gray-400">
        Astuce : <strong>— Aucun</strong> efface la valeur de cette journée.
      </div>
    </div>

    <!-- Footer -->
    <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <button *ngIf="statePickerCurr"
              type="button"
              (click)="deleteAttendanceStateForKey()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium
                     text-white bg-rose-600 hover:bg-rose-700">
        🗑️ Supprimer l’état
      </button>

      <div class="ml-auto flex gap-2">
        <button type="button"
                (click)="closeStatePicker()"
                class="px-4 py-2 rounded-full text-sm font-medium
                       bg-gray-100 hover:bg-gray-200 text-gray-800
                       dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100">
          Annuler
        </button>
        <button type="button"
                (click)="applySelectedAttendanceState()"
                class="px-4 py-2 rounded-full text-sm font-medium
                       text-white bg-green-700 hover:bg-green-800">
          Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>
<!-- ────────────────────────────────────────────────────────────── -->
