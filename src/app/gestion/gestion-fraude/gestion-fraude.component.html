<app-navbar
  [email]="this.auth.currentUser.email"
  [firstName]="this.auth.currentUser.firstName"
  [path]="'home'"
></app-navbar>

<div class="container mx-auto mt-8 px-4">
  <h1 class="text-2xl md:text-3xl font-semibold text-center">Gestion Fraudes</h1>
</div>

<div class="container mx-auto mt-6 px-4">
  <div class="max-w-2xl mx-auto border-2 border-green-800 rounded-lg p-6">
    <h2 class="text-lg font-semibold mb-4">
      {{ editingEntryKey ? "Modifier l'entrée de fraude" : 'Nouvelle entrée de fraude' }}
    </h2>

    <div class="mb-4">
      <label for="fraud-reason" class="block mb-2 text-sm font-medium text-gray-900">
        Raison de fraude
      </label>
      <input
        type="text"
        [(ngModel)]="fraudReason"
        id="fraud-reason"
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
        placeholder="fausse déclaration"
        required
      />
    </div>

    <div class="mb-4">
      <label for="fraud-location" class="block mb-2 text-sm font-medium text-gray-900">
        Localisation
      </label>
      <select
        [(ngModel)]="fraudLocation"
        id="fraud-location"
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
        required
      >
        <option *ngFor="let site of siteLocations" [ngValue]="site">{{ site }}</option>
      </select>
    </div>

    <div class="mb-6">
      <label for="fraud-amount" class="block mb-2 text-sm font-medium text-gray-900">
        Montant de fraude (FC)
      </label>
      <input
        type="text"
        [(ngModel)]="fraudAmount"
        id="fraud-amount"
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
        placeholder="20000"
        required
      />
    </div>

    <div class="flex flex-wrap gap-3">
      <button
        type="button"
        class="text-white bg-green-700 hover:bg-green-800 font-medium rounded-full text-sm px-5 py-2.5"
        routerLink="/gestion-today"
      >
        Retour
      </button>

      <button
        type="button"
        class="text-white bg-red-600 hover:bg-red-700 font-medium rounded-full text-sm px-5 py-2.5"
        (click)="saveFraud()"
        [disabled]="isSaving"
      >
        {{ editingEntryKey ? 'Mettre à jour' : 'Ajouter' }}
      </button>

      <button
        *ngIf="editingEntryKey"
        type="button"
        class="text-white bg-gray-600 hover:bg-gray-700 font-medium rounded-full text-sm px-5 py-2.5"
        (click)="cancelEdit()"
      >
        Annuler modification
      </button>
    </div>
  </div>
</div>

<div class="container mx-auto mt-8 px-4">
  <div class="max-w-4xl mx-auto bg-white border border-gray-200 rounded-lg shadow p-5">
    <h2 class="text-lg font-semibold mb-4">Filtrer le total mensuel</h2>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-900">Mois</label>
        <select
          [(ngModel)]="selectedMonth"
          (change)="applyFilters()"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
        >
          <option *ngFor="let month of [1,2,3,4,5,6,7,8,9,10,11,12]" [ngValue]="month">
            {{ time.monthFrenchNames[month - 1] }}
          </option>
        </select>
      </div>

      <div>
        <label class="block mb-2 text-sm font-medium text-gray-900">Année</label>
        <select
          [(ngModel)]="selectedYear"
          (change)="applyFilters()"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
        >
          <option *ngFor="let year of yearsList" [ngValue]="year">{{ year }}</option>
        </select>
      </div>

      <div>
        <label class="block mb-2 text-sm font-medium text-gray-900">Localisation</label>
        <select
          [(ngModel)]="selectedLocationFilter"
          (change)="applyFilters()"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
        >
          <option *ngFor="let location of locations" [ngValue]="location">
            {{ location === 'Total' ? 'Total (toutes localisations)' : location }}
          </option>
        </select>
      </div>

      <div>
        <label class="block mb-2 text-sm font-medium text-gray-900">Nom de la personne</label>
        <input
          type="text"
          [(ngModel)]="personNameFilter"
          (input)="applyFilters()"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
          placeholder="Ex: Jean"
        />
      </div>
    </div>

    <div class="mt-6 rounded-lg border border-green-200 bg-green-50 p-4">
      <p class="text-sm text-gray-700">
        Total fraude du mois
        <span class="font-medium">
          ({{ time.monthFrenchNames[selectedMonth - 1] }} {{ selectedYear }})
        </span>
      </p>
      <p class="text-2xl font-semibold text-green-700">
        FC {{ monthTotalFiltered | number:'1.0-0' }}
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Filtre actif:
        {{ selectedLocationFilter === 'Total' ? 'Toutes localisations' : selectedLocationFilter }}
      </p>
    </div>
  </div>
</div>

<div class="container mx-auto mt-8 mb-8 px-4">
  <div class="max-w-4xl mx-auto bg-white border border-gray-200 rounded-lg shadow p-5">
    <div class="flex items-center justify-between mb-4">
      <h5 class="text-xl font-bold leading-none text-gray-900">Chronologie (filtrée)</h5>
    </div>

    <div class="flow-root">
      <ul role="list" class="divide-y divide-gray-200">
        <li
          class="py-3 sm:py-4 hover:bg-gray-50"
          *ngFor="let entry of (showAllFraudes ? filteredEntries : filteredEntries.slice(0, 3))"
        >
          <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div class="min-w-0">
              <p class="text-sm font-medium text-gray-900">{{ entry.reason }}</p>
              <p class="text-sm text-gray-500">{{ entry.dateLabel }}</p>
              <p class="text-sm text-gray-500">Localisation: {{ entry.location }}</p>
            </div>
            <div class="flex items-center gap-3">
              <p class="text-sm font-semibold text-gray-900">
                FC {{ entry.amount | number:'1.0-0' }}
              </p>
              <button
                type="button"
                class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-full text-xs px-3 py-1.5"
                (click)="startEdit(entry)"
              >
                Modifier
              </button>
              <button
                type="button"
                class="text-white bg-red-600 hover:bg-red-700 font-medium rounded-full text-xs px-3 py-1.5"
                (click)="deleteEntry(entry)"
                [disabled]="isSaving"
              >
                Supprimer
              </button>
            </div>
          </div>
        </li>
      </ul>

      <p *ngIf="filteredEntries.length === 0" class="text-sm text-gray-500 mt-3">
        Aucune entrée de fraude pour ce filtre.
      </p>

      <div *ngIf="hasMoreFraudes()" class="mt-4 text-center">
        <button
          (click)="showAllFraudes = !showAllFraudes"
          class="text-white bg-green-700 hover:bg-green-800 font-medium rounded-full text-sm px-5 py-2.5 text-center"
        >
          {{ showAllFraudes ? 'Voir moins' : 'Voir plus' }}
        </button>
      </div>
    </div>
  </div>
</div>
