<app-navbar [email]="this.auth.currentUser.email" [firstName]="this.auth.currentUser.firstName" [path]="'home'" [currentClientInfo]="true"></app-navbar>

<!-- ===================== PAGE WRAPPER ===================== -->
<section class="min-h-screen w-full bg-gradient-to-br from-orange-50 via-white to-amber-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 px-4 py-8">
  <!-- ===================== HEADER ===================== -->
  <header class="container mx-auto mb-8 flex flex-col items-center justify-center gap-4 md:flex-row">
    <h2 class="text-2xl font-semibold tracking-tight text-gray-800 dark:text-gray-100 md:text-4xl">Info Clients Sans CrÃ©dit</h2>

    <button routerLink="/register-client" class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-5 py-2.5 text-sm font-medium text-white shadow transition-all duration-150 hover:scale-105 hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-300 dark:bg-emerald-500 dark:hover:bg-emerald-600 dark:focus:ring-emerald-700">
      <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m7-7H5"/></svg>
      Enregistrer Client
    </button>
  </header>

  <!-- ===================== CLIENTS LIST CARD ===================== -->
  <div class="container mx-auto flex justify-center">
    <div class="w-full max-w-2xl rounded-2xl bg-white shadow-xl ring-1 ring-gray-200 dark:bg-slate-800 dark:ring-gray-700">
      <!-- CARD HEADER -->
      <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Clients</h5>
        <div class="flex items-center">
          <label for="search-client-nc" class="sr-only">Chercher</label>
          <div class="relative w-40 sm:w-52 md:w-60">
            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
              <svg class="h-4 w-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            </div>
            <input id="search-client-nc" type="text" [formControl]="searchControl" placeholder="Nom du clientâ€¦" class="w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 pl-10 text-sm text-gray-900 shadow-sm transition focus:border-emerald-500 focus:ring-emerald-500 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400" />
          </div>
        </div>
      </div>

    <!-- CLIENT LIST -->
      <ul role="list" class="divide-y divide-gray-200 dark:divide-gray-700">
        <li
          *ngFor="let s of filteredItems; let i = index"
          [routerLink]="['/client-portal', s.trackingId]"
          class="relative group cursor-pointer px-6 py-4 transition-colors duration-150 hover:bg-amber-50 dark:hover:bg-slate-700/60"
        >
          <!-- ADMIN-ONLY HIDDEN ICON (top-right) -->
          <button
            *ngIf="auth.isAdmin"
            type="button"
            title="Envoyer un message"
            aria-label="Envoyer un message"
            (click)="$event.stopPropagation(); openSmsModal(s)"
            class="absolute right-2 top-2 z-10
                  md:opacity-0 md:group-hover:opacity-100 focus:opacity-100
                  transition-opacity duration-150
                  p-2 rounded-full bg-indigo-600 text-white shadow hover:bg-indigo-700"
          >
            <!-- chat bubble icon -->
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/>
            </svg>
            <span class="sr-only">Envoyer un SMS</span>
          </button>

          <div class="flex items-center space-x-4">
            <!-- AVATAR -->
            <div class="relative inline-flex h-10 w-10 items-center justify-center overflow-hidden rounded-full bg-emerald-100 text-sm font-semibold text-emerald-700 dark:bg-emerald-700 dark:text-emerald-100">
              {{ s.firstName?.substring(0, 2) }}
            </div>

            <!-- CLIENT INFO -->
           <!-- CLIENT INFO -->
<div class="min-w-0 flex-1">
  <!-- Name -->
  <p class="truncate text-sm font-medium text-gray-900 dark:text-gray-100">
    {{ s.firstName }} {{ s.lastName }} {{ s.middleName }}
  </p>

          <!-- Phone + Credit Score -->
          <div class="flex items-center space-x-2">
            <!-- phone -->
            <span class="text-xs text-gray-500 dark:text-gray-400">
              ({{ s.phoneNumber | slice:0:3 }})
              {{ s.phoneNumber | slice:3:6 }}-{{ s.phoneNumber | slice:6:10 }}
            </span>

            <!-- credit score badge -->
           
            <!-- credit-score badge -->
           <!-- credit-score badge -->
              <span
                *ngIf="s.creditScore != null"
                class="inline-block rounded-full px-2 py-0.5 text-[10px] font-semibold shadow-sm tracking-wide"
                [ngStyle]="creditBadgeStyle(s.creditScore)"
              >
                {{ s.creditScore }}
              </span>
          </div>
        </div>


            <!-- SAVINGS -->
            <div class="flex items-center gap-1 text-right">
              <svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 1v22M5 5h14M5 12h14M5 19h14"/>
              </svg>
              <p class="text-sm font-semibold text-gray-900 dark:text-gray-100">
                FC {{ s.savings | number:'1.0-0' }}
              </p>
            </div>
          </div>
        </li>
      </ul>

      <!-- ADMIN TOOLBAR (bulk) -->
<div *ngIf="auth.isAdmin" class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-end">
  <button
    type="button"
    (click)="openBulkModal()"
    class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow transition hover:scale-[1.02] hover:bg-indigo-700"
  >
    <!-- megaphone -->
    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 10v4a3 3 0 0 0 3 3h1l7 4v-18l-7 4H6a3 3 0 0 0-3 3z" />
      <path d="M14 7s5-2 7-3v16c-2-1-7-3-7-3" />
    </svg>
    Relancer en masse
  </button>
</div>


    </div>
  </div>
</section>



<!-- ==== SMS MODAL ==== -->
<div
  *ngIf="smsModal.open"
  class="fixed inset-0 z-50 flex items-center justify-center"
  aria-modal="true" role="dialog"
>
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50" (click)="closeSmsModal()"></div>

  <!-- dialog -->
  <div class="relative z-10 w-full max-w-lg rounded-2xl bg-white dark:bg-slate-800 p-6 shadow-xl">
    <div class="flex items-start justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
        Envoyer un SMS Ã  {{ smsModal.client?.firstName }} {{ smsModal.client?.lastName }}
      </h3>
      <button class="text-gray-500 hover:text-gray-700" (click)="closeSmsModal()">âœ•</button>
    </div>

    <!-- Phone -->
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">
      ðŸ“ž {{ formatDisplayPhone(smsModal.client?.phoneNumber) }}
    </p>

    <!-- Template helper -->
    <div class="flex items-center gap-2 mb-2">
      <button
        class="text-xs rounded-full px-3 py-1 dark:text-white bg-gray-100 dark:bg-slate-700"
        (click)="applyDefaultTemplate()"
      >
        InsÃ©rer le message gÃ©nÃ©rique
      </button>
      <span class="text-xs text-gray-500">Vous pourrez lâ€™Ã©diter ci-dessous</span>
    </div>

    <!-- Textarea -->
    <textarea
      [(ngModel)]="smsModal.message"
      rows="6"
      class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-slate-700 text-gray-900 dark:text-gray-100 p-3"
      placeholder="Saisir ou coller le messageâ€¦"
    ></textarea>

    <!-- Counters -->
    <div class="mt-2 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
      <span>{{ smsModal.message.length || 0 }} caractÃ¨res</span>
      <span>~ {{ estimatedSegments(smsModal.message) }} SMS segment(s)</span>
    </div>

    <!-- Actions -->
    <div class="mt-4 flex items-center justify-end gap-2">
      <button class="px-4 py-2 rounded-lg border dark:text-white hover:bg-slate-300 hover:dark:bg-slate-500" (click)="closeSmsModal()">Annuler</button>
      <button
        class="px-4 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-60"
        [disabled]="sending || !smsModal.message.trim()"
        (click)="sendSmsToClient()"
      >
        {{ sending ? 'Envoiâ€¦' : 'Envoyer' }}
      </button>
    </div>

    <!-- Toast-ish inline status -->
    <p *ngIf="sendResult" class="mt-3 text-sm"
       [class.text-emerald-600]="sendResult.ok"
       [class.text-rose-600]="!sendResult.ok">
      {{ sendResult.text }}
    </p>
  </div>
</div>


<!-- ==== BULK SMS MODAL ==== -->
<div *ngIf="bulkModal.open" class="fixed inset-0 z-50 flex items-center justify-center" aria-modal="true" role="dialog">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/50" (click)="closeBulkModal()"></div>

  <!-- dialog -->
  <div class="relative z-10 w-full max-w-3xl rounded-2xl bg-white dark:bg-slate-800 p-6 shadow-xl">
    <div class="flex items-start justify-between">
      <div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Relancer en masse (clients solvables)</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          Filtrez par score minimal, Ã©ditez le message commun, puis envoyez Ã  tout le monde dâ€™un coup.
        </p>
      </div>
      <button class="text-gray-500 hover:text-gray-700" (click)="closeBulkModal()">âœ•</button>
    </div>

    <!-- Controls -->
    <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Filter panel -->
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 p-4">
        <h4 class="text-sm font-semibold text-gray-900 dark:text-gray-100">CritÃ¨res</h4>
        <label for="minScore" class="mt-3 block text-xs text-gray-500 dark:text-gray-400">Score de crÃ©dit minimal</label>
        <div class="mt-1 flex items-center gap-2">
          <input id="minScore" type="number" min="0" max="100" step="1"
                 [(ngModel)]="bulkModal.minScore"
                 (input)="updateBulkRecipients()"
                 class="w-20 rounded border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-slate-700 px-2 py-1 text-sm text-gray-900 dark:text-gray-100">
          <input type="range" min="0" max="100" step="1"
                 [(ngModel)]="bulkModal.minScore"
                 (input)="updateBulkRecipients()"
                 class="flex-1">
        </div>

        <div class="mt-3 space-y-1 text-xs text-gray-600 dark:text-gray-300">
          <div class="flex items-center justify-between">
            <span>BÃ©nÃ©ficiaires</span>
            <span class="font-semibold">{{ bulkModal.recipients.length }}</span>
          </div>
          <div class="flex items-center justify-between">
            <span>Sans tÃ©lÃ©phone exclu</span>
            <span class="font-semibold">{{ bulkModal.excludedNoPhone }}</span>
          </div>
        </div>
      </div>

      <!-- Message panel -->
      <div class="lg:col-span-2 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
        <div class="flex items-center justify-between">
          <h4 class="text-sm font-semibold text-gray-900 dark:text-gray-100">Message pour tous</h4>
          <button
            class="text-xs rounded-full px-3 py-1 bg-gray-100 dark:bg-slate-700 dark:text-white"
            (click)="applyDefaultBulkTemplate()"
          >
            InsÃ©rer le message gÃ©nÃ©rique
          </button>
        </div>

        <textarea
          [(ngModel)]="bulkModal.message"
          rows="6"
          class="mt-2 w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-slate-700 text-gray-900 dark:text-gray-100 p-3"
          placeholder="Saisir le message commun pour tousâ€¦"
        ></textarea>
        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          Variables disponibles :
          <ng-container *ngFor="let t of placeholderTokens; let last = last">
            <code>{{ t }}</code><span *ngIf="!last">, </span>
          </ng-container>
        </div>


        <div class="mt-2 rounded-lg bg-gray-50 dark:bg-slate-700 p-2 text-xs text-gray-700 dark:text-gray-100">
          <span class="font-medium">AperÃ§u (1er destinataire) :</span>
          <pre class="whitespace-pre-wrap">{{ previewPersonalized() }}</pre>
        </div>

        <div class="mt-2 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
          <span>{{ bulkModal.message.length || 0 }} caractÃ¨res</span>
          <span>~ {{ estimatedSegments(bulkModal.message) }} segment(s) SMS</span>
        </div>
      </div>
    </div>

    <!-- Recipients preview -->
    <div class="mt-4 rounded-xl border border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between px-4 py-3">
        <h4 class="text-sm font-semibold text-gray-900 dark:text-gray-100">
          {{ bulkModal.recipients.length }} client(s) ciblÃ©(s)
        </h4>
        <span class="text-xs text-gray-500 dark:text-gray-400">Cliquez un client pour ouvrir son portail</span>
      </div>
      <div class="max-h-64 overflow-auto divide-y divide-gray-200 dark:divide-gray-700">
        <div *ngFor="let c of bulkModal.recipients"
             class="px-4 py-3 flex items-center justify-between hover:bg-amber-50 dark:hover:bg-slate-700/60">
          <div class="min-w-0">
            <p class="truncate text-sm font-medium text-gray-900 dark:text-gray-100">
              {{ c.firstName }} {{ c.lastName }} {{ c.middleName }}
            </p>
            <div class="mt-0.5 flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
              <span>{{ formatDisplayPhone(c.phoneNumber) }}</span>
              <span
                *ngIf="c.creditScore != null"
                class="inline-block rounded-full px-2 py-0.5 text-[10px] font-semibold shadow-sm tracking-wide"
                [ngStyle]="creditBadgeStyle(c.creditScore)">
                {{ c.creditScore }}
              </span>
            </div>
          </div>
          <a class="text-xs font-medium text-indigo-600 hover:text-indigo-800 dark:text-indigo-400"
             [routerLink]="['/client-portal', c.trackingId]">
            Ouvrir le portail â†’
          </a>
        </div>
      </div>
    </div>

    <!-- Actions & results -->
    <div class="mt-4 flex items-center justify-end gap-2">
      <button class="px-4 py-2 rounded-lg border dark:text-white hover:bg-slate-300 hover:dark:bg-slate-500"
              (click)="closeBulkModal()">
        Annuler
      </button>
      <button
        class="px-4 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-60"
        [disabled]="bulkSending || !bulkModal.message.trim() || bulkModal.recipients.length === 0"
        (click)="sendBulkSms()">
        {{ bulkSending ? 'Envoi en coursâ€¦' : ('Envoyer Ã  ' + bulkModal.recipients.length + ' client(s)') }}
      </button>
    </div>

    <!-- Summary -->
    <div *ngIf="bulkModal.result" class="mt-4 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
      <p class="text-sm"
         [class.text-emerald-600]="bulkModal.result.succeeded > 0 && bulkModal.result.failed === 0"
         [class.text-amber-600]="bulkModal.result.failed > 0">
        EnvoyÃ©s: <strong>{{ bulkModal.result.succeeded }}</strong> /
        CiblÃ©s: <strong>{{ bulkModal.result.total }}</strong>
        <span *ngIf="bulkModal.result.failed > 0"> | Ã‰checs: <strong>{{ bulkModal.result.failed }}</strong></span>
      </p>

      <div *ngIf="bulkModal.result.failures?.length" class="mt-3">
        <h5 class="text-xs font-semibold text-rose-600">DÃ©tails des Ã©checs</h5>
        <ul class="mt-1 list-disc pl-5 text-xs text-gray-600 dark:text-gray-300">
          <li *ngFor="let f of bulkModal.result.failures">
            {{ f.client.firstName }} {{ f.client.lastName }} ({{ formatDisplayPhone(f.client.phoneNumber) }}) â€” {{ f.error }}
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
