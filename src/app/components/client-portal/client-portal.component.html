<!-- ==== TOP PROFILE HEADER – modern look ==== -->
<app-navbar
  [email]="this.auth.currentUser.email"
  [firstName]="this.auth.currentUser.firstName"
  [path]="'home'"
></app-navbar>

<!-- Hero banner with title & action -->
<header
  class="relative mx-auto mt-6 flex max-w-7xl flex-col items-center justify-between gap-6 rounded-3xl bg-gradient-to-r from-green-600 via-emerald-500 to-lime-500 px-6 py-10 shadow-xl sm:flex-row sm:px-10 lg:px-16"
>
  <!-- Title -->
  <h1
    class="text-center text-3xl font-extrabold tracking-tight text-white drop-shadow sm:text-4xl"
  >
    Profil du Client
  </h1>

  <!-- Update-info button -->
  <button
    type="submit"
    class="inline-flex items-center justify-center rounded-full bg-white/10 px-6 py-3 text-sm font-medium text-white ring-2 ring-white/30 backdrop-blur transition hover:bg-white/20 focus:outline-none focus:ring-4 focus:ring-white/50"
    [routerLink]="['/update-client-info', id]"
  >
    Mettre à jour&nbsp;Info Client
  </button>

  <!-- soft decorative bubbles -->
  <span
    class="pointer-events-none absolute -top-6 right-10 h-24 w-24 rounded-full bg-white/20 blur-3xl sm:block"
  ></span>
  <span
    class="pointer-events-none absolute bottom-0 left-0 h-16 w-16 rounded-full bg-white/10 blur-2xl"
  ></span>
</header>

<div class="mx-auto flex max-w-7xl flex-col items-center justify-center py-8">
  <!-- If no picture yet -->
  <div *ngIf="!client?.profilePicture" class="flex flex-col items-center">
    <input
      type="file"
      [id]="'putPicture'"
      class="hidden"
      (change)="startUpload($any($event.target).files)"
    />
    <button
      (click)="onImageClick('putPicture')"
      type="button"
      class="inline-flex items-center justify-center rounded-full bg-green-600 px-6 py-3 text-sm font-medium text-white shadow hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800"
    >
      Ajouter Photo du Client
    </button>
  </div>
  <!-- Photo uploader / viewer -->
  <!-- Show picture (preview + actions) -->
  <div
    *ngIf="client?.profilePicture"
    class="relative flex flex-col items-center"
  >
    <!-- hidden file input for replacing the photo -->
    <input
      type="file"
      id="changePicture"
      class="hidden"
      (change)="startUpload($any($event.target).files)"
    />

    <!-- circular preview – click = view full -->
    <img
      [src]="client.profilePicture!.downloadURL"
      alt="Photo du Client"
      class="h-64 w-64 cursor-pointer rounded-full object-cover shadow-lg transition md:h-80 md:w-80"
      (click)="toggleFullPicture()"
    />

    <!-- small “edit” button sitting on the preview -->
    <button
      (click)="onImageClick('changePicture')"
      type="button"
      class="absolute bottom-4 right-4 flex h-10 w-10 items-center justify-center rounded-full bg-black/60 text-white shadow-lg hover:bg-black/80 focus:outline-none"
      title="Changer la photo"
    >
      <!-- pencil icon -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="1.8"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M15.232 5.232l3.536 3.536M4 20h4.586a2 2 0 0 0 1.414-.586l9.536-9.536a2 2 0 0 0 0-2.828l-3.536-3.536a2 2 0 0 0-2.828 0L4.636 13.05A2 2 0 0 0 4 14.464V20z"
        />
      </svg>
    </button>
  </div>
</div>

<!-- full-screen modal (toggles with click) -->
<div
  *ngIf="isFullPictureVisible"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/80"
  (click)="toggleFullPicture()"
>
  <img
    [src]="client.profilePicture!.downloadURL"
    alt="Photo du Client – plein écran"
    class="max-h-[90vh] max-w-[90vw] rounded-2xl shadow-2xl"
    (click)="$event.stopPropagation()"
  />
  <button
    (click)="toggleFullPicture()"
    type="button"
    class="absolute top-6 right-6 text-4xl font-bold text-white hover:text-gray-300 focus:outline-none"
    aria-label="Fermer"
  >
    &times;
  </button>
</div>

<!-- Trophy badges -->
<div class="mx-auto flex w-full max-w-7xl flex-col items-center px-4">
  <div class="trophy-grid">
    <!-- SILVER -->
    <div *ngIf="isSilver" class="trophy-card trophy-card--silver">
      <img
        src="../../../assets/img/winner.png"
        alt="Argent"
        class="trophy-card__icon"
      />
      <span class="trophy-card__label">Argent</span>
      <p class="trophy-card__range">Score 70 – 99</p>
      <!-- Stars next to trophy -->
      <div
        *ngIf="stars > 0"
        class="mt-2 flex flex-col items-center"
      >
        <button
          (click)="showStarsExplanation = !showStarsExplanation"
          type="button"
          class="flex items-center gap-1 text-amber-600 hover:text-amber-700 transition-colors dark:text-amber-400 dark:hover:text-amber-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
            />
          </svg>
          <span class="text-xs font-semibold">{{ stars }}</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-3 w-3 transition-transform"
            [ngClass]="showStarsExplanation ? 'rotate-180' : ''"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <!-- Expandable explanation -->
        <div
          *ngIf="showStarsExplanation"
          class="mt-2 max-w-[200px] rounded-lg bg-amber-50 px-3 py-2 text-[10px] text-amber-800 shadow-md dark:bg-amber-900/40 dark:text-amber-200"
        >
          <p class="font-semibold mb-1">Étoiles</p>
          <p>
            Nombre de célébrations des accomplissements du client.
          </p>
        </div>
      </div>
    </div>

    <!-- GOLD -->
    <div *ngIf="isGold" class="trophy-card trophy-card--gold">
      <img
        src="../../../assets/img/winner.png"
        alt="Or"
        class="trophy-card__icon"
      />
      <span class="trophy-card__label">Or</span>
      <p class="trophy-card__range">Score 100+</p>
      <!-- Stars next to trophy -->
      <div
        *ngIf="stars > 0"
        class="mt-2 flex flex-col items-center"
      >
        <button
          (click)="showStarsExplanation = !showStarsExplanation"
          type="button"
          class="flex items-center gap-1 text-amber-600 hover:text-amber-700 transition-colors dark:text-amber-400 dark:hover:text-amber-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
            />
          </svg>
          <span class="text-xs font-semibold">{{ stars }}</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-3 w-3 transition-transform"
            [ngClass]="showStarsExplanation ? 'rotate-180' : ''"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <!-- Expandable explanation -->
        <div
          *ngIf="showStarsExplanation"
          class="mt-2 max-w-[200px] rounded-lg bg-amber-50 px-3 py-2 text-[10px] text-amber-800 shadow-md dark:bg-amber-900/40 dark:text-amber-200"
        >
          <p class="font-semibold mb-1">Étoiles</p>
          <p>
            Nombre de célébrations des accomplissements du client.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ==== /TOP PROFILE HEADER ==== -->

<!-- ==== CLIENT PROFILE CARD (modern look) ==== -->
<div
  id="fullWidthTabContent"
  class="mx-4 lg:mx-60 my-8 overflow-hidden rounded-3xl bg-white/70 shadow-xl ring-1 ring-gray-200 backdrop-blur dark:bg-gray-800/70 dark:ring-gray-700"
>
  <!-- decorative top bar -->
  <div
    class="h-2 w-full bg-gradient-to-r from-green-400 via-emerald-500 to-lime-400 dark:from-emerald-600 dark:via-teal-500 dark:to-cyan-400"
  ></div>

  <!-- main grid -->
  <dl
    class="grid gap-6 p-6 sm:grid-cols-2 xl:grid-cols-3 text-gray-900 dark:text-white"
  >
    <!-- Name & vital status -->
    <div class="col-span-full flex flex-col items-center">
      <h2
        class="text-2xl font-extrabold tracking-tight sm:text-3xl text-center"
      >
        {{ client.firstName }} {{ client.lastName }}
        <span *ngIf="client.middleName"> {{ client.middleName }}</span>
      </h2>
      <p class="mt-1 text-sm font-medium text-gray-500 dark:text-gray-400">
        Membre depuis {{ dateJoined }}
      </p>
      <span
        class="mt-2 inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-sm font-semibold text-green-800 dark:bg-green-900/40 dark:text-green-300"
      >
        {{ client.vitalStatus }}
      </span>
      <!-- Stars display below name -->
      <div *ngIf="stars > 0" class="mt-3 flex flex-col items-center">
        <button
          (click)="showStarsExplanation = !showStarsExplanation"
          type="button"
          class="inline-flex items-center gap-1.5 rounded-full bg-amber-50 px-3 py-1.5 text-sm font-semibold text-amber-700 hover:bg-amber-100 transition-colors dark:bg-amber-900/30 dark:text-amber-300 dark:hover:bg-amber-900/40"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-amber-500 dark:text-amber-400"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
            />
          </svg>
          <span>{{ stars }}</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 transition-transform"
            [ngClass]="showStarsExplanation ? 'rotate-180' : ''"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <!-- Expandable explanation -->
        <div
          *ngIf="showStarsExplanation"
          class="mt-2 max-w-md rounded-lg bg-amber-50 px-4 py-3 text-xs text-amber-800 shadow-md dark:bg-amber-900/40 dark:text-amber-200"
        >
          <p class="font-semibold mb-1">Que représentent les étoiles ?</p>
          <p>
            Les étoiles indiquent le nombre de fois que ce client a été célébré pour ses accomplissements et ses réussites. Chaque étoile représente une célébration spéciale de leurs performances exceptionnelles.
          </p>
        </div>
      </div>
    </div>

    <!-- Age -->
    <div
      *ngIf="age !== null"
      class="flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Âge</dt>
      <dd class="mt-1 text-3xl font-bold">{{ age }}</dd>
      <dd
        *ngIf="birthDateDisplay"
        class="mt-1 text-xs text-gray-500 dark:text-gray-400"
      >
        Né(e) le {{ birthDateDisplay }}
      </dd>
    </div>

    <!-- Phone number (centered) + history -->
    <div
      class="relative flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 transition hover:shadow-lg dark:bg-gray-900/50"
      #phoneHistory
    >
      <dt class="text-lg font-semibold">Téléphone</dt>

      <dd class="mt-1 w-full">
        <div class="flex flex-col items-center justify-center gap-2">
          <!-- main number -->
          <a
            [href]="'tel:' + client.phoneNumber"
            class="text-xl font-bold tracking-wide text-center whitespace-nowrap max-w-[90%] overflow-hidden text-ellipsis hover:underline"
          >
            {{ formatPhone(client.phoneNumber) }}
          </a>

          <!-- toggle (isolated in a relative wrapper so the menu centers correctly) -->
          <div *ngIf="allPhones.length > 1" class="relative">
            <button
              type="button"
              class="inline-flex items-center gap-1 rounded-full border px-2.5 py-1 text-xs font-medium border-slate-200 bg-white/70 shadow-sm ring-1 ring-black/5 dark:border-slate-700 dark:bg-slate-800"
              (click)="$event.stopPropagation(); togglePhoneHistory()"
              [title]="
                allPhones.length > 1
                  ? 'Historique (' + allPhones.length + ')'
                  : 'Historique vide'
              "
            >
              <span>Historique</span>
              <span
                *ngIf="allPhones.length > 1"
                class="ml-1 inline-flex h-5 min-w-[20px] items-center justify-center rounded-full bg-emerald-600 px-1 text-[11px] font-semibold text-white"
              >
                {{ allPhones.length }}
              </span>
              <svg
                class="ml-1 h-3.5 w-3.5"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"
                />
              </svg>
            </button>

            <!-- centered dropdown -->
            <div
              *ngIf="showPhoneHistory && allPhones.length"
              class="absolute left-1/2 z-20 mt-2 w-72 max-w-[90vw] -translate-x-1/2 rounded-xl border border-slate-200 bg-white p-2 shadow-2xl ring-1 ring-black/5 dark:border-slate-700 dark:bg-slate-800"
            >
              <div
                class="px-2 py-1 text-xs font-semibold text-slate-500 dark:text-slate-300"
              >
                Historique des numéros
              </div>

              <ul
                class="max-h-60 overflow-auto divide-y divide-slate-100 dark:divide-slate-700"
              >
                <li
                  *ngFor="let p of allPhones; let i = index"
                  class="flex items-center justify-between gap-2 px-2 py-2"
                >
                  <div class="min-w-0">
                    <a
                      [href]="'tel:' + p"
                      class="font-mono text-sm text-slate-800 hover:underline dark:text-slate-100"
                    >
                      {{ formatPhone(p) }}
                    </a>
                    <span
                      *ngIf="i === 0"
                      class="ml-2 inline-flex items-center rounded-full bg-emerald-50 px-2 py-0.5 text-[10px] font-semibold text-emerald-700 ring-1 ring-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-300 dark:ring-emerald-800"
                    >
                      Actuel
                    </span>
                  </div>

                  <div class="flex items-center gap-1 shrink-0">
                    <a
                      [href]="'sms:' + p"
                      class="rounded-md px-2 py-1 text-[11px] ring-1 ring-inset ring-slate-200 hover:bg-slate-50 dark:ring-slate-700 dark:hover:bg-slate-700/60"
                    >
                      SMS
                    </a>
                    <button
                      type="button"
                      (click)="copy(p)"
                      class="rounded-md px-2 py-1 text-[11px] ring-1 ring-inset ring-slate-200 hover:bg-slate-50 dark:ring-slate-700 dark:hover:bg-slate-700/60"
                    >
                      {{ copied === p ? "Copié ✓" : "Copier" }}
                    </button>
                  </div>
                </li>
              </ul>

              <div
                class="px-2 pt-1 text-[11px] text-slate-400 dark:text-slate-400"
              >
                Astuce : les numéros en double sont regroupés automatiquement.
              </div>
            </div>
          </div>
        </div>
      </dd>
    </div>

    <!-- Business address -->
    <a
      [routerLink]="['/update-client-info', id]"
      class="flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 transition hover:shadow-lg dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Adresse Business</dt>
      <dd class="mt-1 text-center text-sm font-medium">
        {{ client.businessAddress }}
      </dd>
    </a>

    <!-- Loan amount -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gradient-to-br from-amber-50 to-amber-100 px-4 py-6 dark:from-gray-900/60 dark:to-gray-800/60"
    >
      <dt class="text-lg font-semibold">Montant Emprunté (FC)</dt>
      <dd class="mt-1 text-3xl font-extrabold">
        {{ client.loanAmount | number : "1.0-0" }}
      </dd>
    </div>

    <!-- Amount paid -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gradient-to-br from-green-50 to-green-100 px-4 py-6 dark:from-gray-900/60 dark:to-gray-800/60"
    >
      <dt class="text-lg font-semibold">Montant Perçu (FC)</dt>
      <dd class="mt-1 text-3xl font-extrabold">
        {{ client.amountPaid | number : "1.0-0" }}
      </dd>
    </div>

    <!-- Debt left -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gradient-to-br from-rose-50 to-rose-100 px-4 py-6 dark:from-gray-900/60 dark:to-gray-800/60"
    >
      <dt class="text-lg font-semibold">Montant Restant (FC)</dt>
      <dd class="mt-1 text-3xl font-extrabold">
        {{ client.debtLeft | number : "1.0-0" }}
      </dd>
    </div>

    <!-- Amount to pay -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gradient-to-br from-sky-50 to-sky-100 px-4 py-6 dark:from-gray-900/60 dark:to-gray-800/60"
    >
      <dt class="text-lg font-semibold">Montant à Payer (FC)</dt>
      <dd class="mt-1 text-3xl font-extrabold">
        {{ client.amountToPay | number : "1.0-0" }}
      </dd>
    </div>

    <!-- Debt cycle -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Cycle de Dette</dt>
      <dd class="mt-1 text-xl font-bold">{{ client.debtCycle }}</dd>
      <p class="text-xs text-gray-500 dark:text-gray-400">
        {{ debtStart }} &rarr; {{ debtEnd }}
      </p>
    </div>

    <!-- Payments made -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Nombre De Paiements Reçus</dt>
      <dd class="mt-1 text-3xl font-extrabold">
        {{ client.numberOfPaymentsMade }}
      </dd>
    </div>

    <!-- Savings -->
    <div
      class="flex flex-col items-center rounded-2xl bg-lime-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Épargnes (FC)</dt>
      <dd class="mt-1 text-3xl font-extrabold">
        {{ client.savings | number : "1.0-0" }}
      </dd>
    </div>

    <div
      *ngIf="bonusAmountValue > 0"
      class="relative flex flex-col items-center rounded-2xl bg-amber-50 px-4 py-6 transition focus:outline-none bonus-highlight dark:bg-gray-900/50"
      role="button"
      tabindex="0"
      (click)="showBonusHistory = !showBonusHistory"
      (keydown.enter)="showBonusHistory = !showBonusHistory"
      (keydown.space)="showBonusHistory = !showBonusHistory"
      #bonusHistoryCard
    >
      <dt class="text-lg font-semibold text-gray-900 dark:text-white">
        Bonus Disponible (FC)
      </dt>
      <dd class="mt-1 text-3xl font-extrabold text-gray-900 dark:text-white">
        {{ bonusAmountValue | number : "1.0-0" }}
      </dd>
      <span
        class="pointer-events-none absolute top-4 right-4 flex h-8 w-8 items-center justify-center rounded-full bg-white/70 text-amber-600 shadow-sm"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 transition-transform"
          [ngClass]="showBonusHistory ? 'rotate-180' : ''"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </span>

      <div
        *ngIf="showBonusHistory"
        class="absolute left-1/2 top-[calc(100%+0.75rem)] z-20 w-72 max-w-xs -translate-x-1/2 rounded-2xl border border-amber-200 bg-white p-3 shadow-2xl dark:border-amber-500/30 dark:bg-gray-900"
        (click)="$event.stopPropagation()"
      >
        <h4 class="text-sm font-semibold text-gray-900 dark:text-gray-100">
          Historique des bonus
        </h4>
        <ul class="mt-2 max-h-64 space-y-2 overflow-auto">
          <li
            *ngFor="let event of bonusHistoryList"
            class="rounded-xl border border-amber-100 bg-amber-50/70 p-2 text-xs dark:border-amber-500/30 dark:bg-amber-500/10"
          >
            <div class="flex justify-between">
              <span class="font-semibold text-gray-800 dark:text-gray-100">
                {{ bonusEventLabel(event) }}
              </span>
              <span
                [ngClass]="
                  bonusEventAmount(event) >= 0
                    ? 'text-emerald-600 dark:text-emerald-400'
                    : 'text-rose-600 dark:text-rose-400'
                "
              >
                {{ bonusEventAmount(event) >= 0 ? '+' : ''
                }}{{ bonusEventAmount(event) | number : '1.0-0' }} FC
              </span>
            </div>
            <div class="mt-1 text-gray-500 dark:text-gray-400">
              {{ formatISOToDRC(event.createdAt) }}
            </div>
            <div class="mt-1 text-gray-500 dark:text-gray-400">
              Solde: {{ bonusEventBalance(event) | number : '1.0-0' }} FC
            </div>
            <div
              *ngIf="event.note && event.note !== bonusEventLabel(event)"
              class="mt-1 text-[11px] text-gray-500 dark:text-gray-400"
            >
              {{ event.note }}
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Min Pay -->
    <div
      class="flex flex-col items-center rounded-2xl bg-lime-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Paiement Minimum (FC)</dt>
      <dd class="mt-1 text-3xl font-extrabold">
        {{ minPay | number : "1.0-0" }}
      </dd>
    </div>

    <!-- Agent -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Agent</dt>
      <dd class="mt-1 text-center text-sm font-medium">
        {{ agent?.firstName }} {{ agent?.middleName }} {{ agent?.lastName }}
      </dd>
    </div>

    <!-- Payment day -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Jour de Paiement</dt>
      <dd class="mt-1 text-2xl font-bold">{{ client.frenchPaymentDay }}</dd>
    </div>

    <!-- Credit score -->
    <div
      class="flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Score Crédit</dt>
      <dd class="mt-1 text-3xl font-extrabold">{{ client.creditScore }}</dd>
    </div>

    <!-- Next payment date (desktop-only) -->
    <div
      class="hidden md:flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Prochaine Échéance</dt>
      <dd class="mt-1 text-2xl font-bold">
        {{ client.frenchPaymentDay }} {{ paymentDate }}
      </dd>
    </div>

    <!-- References -->
    <div
      *ngIf="client.references"
      class="hidden md:flex flex-col items-center rounded-2xl bg-gray-50 px-4 py-6 dark:bg-gray-900/50"
    >
      <dt class="text-lg font-semibold">Références</dt>

      <div *ngFor="let r of client.references">
        <dd class="mt-1 text-center text-sm font-medium">{{ r }}</dd>
      </div>
    </div>
    <!-- Previous Cycles -->
    <div
      *ngIf="clientCycles.length > 0"
      class="col-span-full rounded-2xl bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 border border-slate-200 dark:border-slate-700 overflow-hidden"
    >
      <!-- Header - Clickable to toggle -->
      <button
        type="button"
        (click)="showPreviousCycles = !showPreviousCycles"
        class="w-full flex items-center justify-between px-6 py-4 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
      >
        <div class="flex items-center gap-3">
          <svg
            class="w-5 h-5 text-slate-600 dark:text-slate-300"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <dt class="text-lg font-semibold text-slate-900 dark:text-white">
            Cycles Précédents
          </dt>
          <span
            class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300"
          >
            {{ clientCycles.length }}
          </span>
        </div>
        <svg
          class="w-5 h-5 text-slate-600 dark:text-slate-300 transition-transform duration-200"
          [ngClass]="showPreviousCycles ? 'rotate-180' : ''"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19 9l-7 7-7-7"
          />
        </svg>
      </button>

      <!-- Collapsible Content -->
      <div
        *ngIf="showPreviousCycles"
        class="px-6 pb-6 border-t border-slate-200 dark:border-slate-700"
      >
        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4 mt-4">
          Consultez les cycles de dette précédents de ce client
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <a
            *ngFor="let c of clientCycles"
            [routerLink]="['/client-cycle', client.uid + '-' + c.cycleId]"
            class="group flex items-center gap-3 p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-emerald-500 dark:hover:border-emerald-500 hover:shadow-lg transition-all cursor-pointer"
          >
            <div
              class="flex-shrink-0 w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center group-hover:bg-emerald-500 dark:group-hover:bg-emerald-600 transition-colors"
            >
              <svg
                class="w-5 h-5 text-emerald-600 dark:text-emerald-300 group-hover:text-white transition-colors"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-base font-semibold text-slate-900 dark:text-white group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors">
                Cycle {{ c.debtCycle }}
              </p>
              <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                Cliquez pour voir les détails
              </p>
            </div>
            <svg
              class="w-5 h-5 text-slate-400 group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors flex-shrink-0"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </a>
        </div>
      </div>
    </div>

    <!-- Verification banner -->
    <div
      *ngIf="agentVerifyingName !== '' && (auth.isAdmin || auth.isDistributor)"
      class="col-span-full flex justify-center"
    >
      <span
        class="inline-flex items-center rounded-full bg-green-100 px-4 py-2 text-sm font-semibold text-green-700 dark:bg-green-900/40 dark:text-green-200"
      >
        ✔️ Client vérifié par {{ agentVerifyingName }}
      </span>
    </div>
  </dl>

  <!-- action buttons row -->
  <div
    class="flex flex-wrap justify-center gap-4 border-t border-gray-200 bg-gray-50 px-6 py-4 dark:border-gray-700 dark:bg-gray-900/60"
  >
    <button
      class="rounded-full bg-green-600 px-6 py-2 text-sm font-medium text-white shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400"
      [routerLink]="['/payment', id]"
    >
      Effectuer un Paiement
    </button>

    <button
      class="rounded-full bg-green-600 px-6 py-2 text-sm font-medium text-white shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400"
      [routerLink]="['/payment-activity', id]"
    >
      Détails de Paiement
    </button>

    <button
      class="rounded-full bg-green-600 px-6 py-2 text-sm font-medium text-white shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400"
      [routerLink]="['/saving-activity', id]"
    >
      Détails d'Épargne
    </button>

    <button
      *ngIf="auth.isAdmin"
      (click)="openBonusModal()"
      type="button"
      class="rounded-full bg-amber-500 px-6 py-2 text-sm font-medium text-white shadow hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-300"
    >
      Ajouter Bonus
    </button>

    <button
      *ngIf="bonusAmountValue > 0"
      (click)="transferBonusToSavings()"
      type="button"
      [disabled]="isBonusTransferSubmitting"
      class="rounded-full bg-amber-500 px-6 py-2 text-sm font-medium text-white shadow hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-300 disabled:cursor-not-allowed disabled:opacity-60"
    >
      {{
        isBonusTransferSubmitting
          ? 'Transfert en cours...'
          : 'Transférer Bonus vers Épargne'
      }}
    </button>
  </div>
</div>
<!-- ==== /CLIENT PROFILE CARD ==== -->

<!-- ==== ACTION BUTTON STRIP ==== -->
<div
  class="mx-auto my-10 flex max-w-7xl flex-wrap items-center justify-center gap-4 px-4"
  role="group"
>
  <!-- New Debt Cycle -->
  <button
    (click)="startNewDebtCycle()"
    type="button"
    class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-6 py-3 text-sm font-medium text-white shadow-lg transition hover:scale-105 hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-400/40 dark:focus:ring-emerald-600/50"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="1.5"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </svg>
    Enregistrement&nbsp;Nouveau&nbsp;Cycle
  </button>

  <!-- Delete (admin only) -->
  <button
    *ngIf="auth.isAdmin"
    (click)="delete()"
    type="button"
    class="inline-flex items-center gap-2 rounded-full bg-red-600 px-6 py-3 text-sm font-medium text-white shadow-lg transition hover:scale-105 hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-400/40 dark:focus:ring-red-600/50"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="1.5"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m5 0H4m3-3h10l1 3H6l1-3z"
      />
    </svg>
    Supprimer&nbsp;Client
  </button>

  <!-- Savings withdrawal request -->
  <button
    (click)="requestWithDrawFromSavings()"
    type="button"
    class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-6 py-3 text-sm font-medium text-white shadow-lg transition hover:scale-105 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-400/40 dark:focus:ring-indigo-600/50"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="1.5"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M12 8c1.886 0 3.414-1.28 3.863-3H18V3h-2.137C15.414 1.28 13.886 0 12 0S8.586 1.28 8.137 3H6v2h2.137C8.586 6.72 10.114 8 12 8zM6 9v10h12V9H6zm6 3v4"
      />
    </svg>
    Demander Retrait&nbsp;Épargne
  </button>

  <!-- Confirm savings withdrawal -->
  <button
    (click)="withDrawFromSavings()"
    type="button"
    class="inline-flex items-center gap-2 rounded-full bg-teal-600 px-6 py-3 text-sm font-medium text-white shadow-lg transition hover:scale-105 hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-400/40 dark:focus:ring-teal-600/50"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="1.5"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
    </svg>
    {{ savingsText }}
  </button>
</div>

<div
  *ngIf="showBonusModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"
  (click)="closeBonusModal()"
>
  <div
    class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl ring-1 ring-black/10 dark:bg-gray-800 dark:ring-white/10"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-start justify-between">
      <div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Ajouter un Bonus
        </h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          Bonus actuel :
          <span class="font-semibold text-gray-800 dark:text-gray-200">
            {{ bonusAmountValue | number : '1.0-0' }} FC
          </span>
        </p>
      </div>
      <button
        type="button"
        class="text-gray-400 transition hover:text-gray-600 dark:hover:text-gray-200"
        (click)="closeBonusModal()"
        [disabled]="isBonusSubmitting"
      >
        ×
      </button>
    </div>

    <div class="mt-6">
      <label
        for="bonusAmount"
        class="block text-sm font-medium text-gray-700 dark:text-gray-300"
        >Montant du bonus</label
      >
      <input
        id="bonusAmount"
        type="number"
        [(ngModel)]="bonusToAdd"
        [disabled]="isBonusSubmitting"
        class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 disabled:cursor-not-allowed disabled:bg-gray-100 dark:border-gray-700 dark:bg-gray-900 dark:text-white dark:focus:border-amber-400 dark:focus:ring-amber-500"
        placeholder="Entrez le montant"
        step="0.01"
      />
    </div>

    <div class="mt-6 flex justify-end gap-3">
      <button
        type="button"
        class="rounded-full border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-700"
        (click)="closeBonusModal()"
        [disabled]="isBonusSubmitting"
      >
        Annuler
      </button>
      <button
        type="button"
        class="rounded-full bg-amber-500 px-4 py-2 text-sm font-medium text-white shadow hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-300 disabled:cursor-not-allowed disabled:opacity-60"
        (click)="submitBonus()"
        [disabled]="isBonusSubmitting"
      >
        {{ isBonusSubmitting ? 'Ajout...' : 'Confirmer' }}
      </button>
    </div>
  </div>
</div>

<!-- ==== CREDIT GRAPH PANEL (Performance Ring) ==== -->
<div
  class="mx-auto mb-16 flex max-w-7xl flex-col items-center justify-center px-4"
>
  <div
    class="w-full rounded-3xl bg-white/70 p-6 shadow-lg ring-1 ring-gray-200 backdrop-blur dark:bg-gray-800/70 dark:ring-gray-700"
  >
    <!-- PERFORMANCE RING -->
    <div
      class="container mt-2 flex mx-auto flex-col md:flex-row md:justify-center"
    >
      <div class="w-full max-w-xl mx-auto">
        <div
          class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 p-6 shadow-sm backdrop-blur-md dark:border-slate-700 dark:from-slate-900 dark:to-slate-900/80"
        >
          <div
            class="w-full rounded-3xl bg-white/70 p-6 shadow-lg ring-1 ring-gray-200 backdrop-blur dark:bg-gray-800/70 dark:ring-gray-700"
          >
            <!-- Title -->
            <h3
              class="mb-4 text-center text-xl font-bold tracking-tight text-slate-800 dark:text-slate-100"
            >
              Client Score Credit
            </h3>

            <div class="relative flex items-center justify-center">
              <svg
                [attr.width]="size"
                [attr.height]="size"
                [attr.viewBox]="'0 0 ' + size + ' ' + size"
                class="drop-shadow-sm"
              >
                <defs>
                  <!-- subtle glow -->
                  <filter
                    id="perfGlow"
                    x="-50%"
                    y="-50%"
                    width="200%"
                    height="200%"
                  >
                    <feGaussianBlur stdDeviation="3.5" result="blur" />
                    <feMerge>
                      <feMergeNode in="blur" />
                      <feMergeNode in="SourceGraphic" />
                    </feMerge>
                  </filter>

                  <!-- very faint trail gradient -->
                  <linearGradient
                    [attr.id]="gradId"
                    x1="0%"
                    y1="0%"
                    x2="100%"
                    y2="100%"
                  >
                    <stop offset="0%" stop-color="#e5e7eb" />
                    <stop offset="100%" stop-color="#cbd5e1" />
                  </linearGradient>
                </defs>

                <!-- background ring -->
                <circle
                  [attr.cx]="center"
                  [attr.cy]="center"
                  [attr.r]="radius2"
                  [attr.stroke]="'url(#' + gradId + ')'"
                  [attr.stroke-width]="strokeWidth"
                  fill="none"
                ></circle>

                <!-- tick marks (every 10%) -->
                <g
                  [attr.transform]="'translate(' + center + ',' + center + ')'"
                >
                  <ng-container *ngFor="let t of ticks">
                    <line
                      [attr.x1]="0"
                      [attr.y1]="-radius2"
                      [attr.x2]="0"
                      [attr.y2]="-radius2 + 8"
                      stroke="#c7d2fe"
                      stroke-width="2"
                      [attr.transform]="'rotate(' + t + ')'"
                      class="opacity-50 dark:opacity-40"
                    />
                  </ng-container>
                </g>

                <!-- progress arc -->
                <circle
                  [attr.cx]="center"
                  [attr.cy]="center"
                  [attr.r]="radius2"
                  [attr.stroke]="colorForPerf(avgPerf)"
                  [attr.stroke-width]="strokeWidth"
                  stroke-linecap="round"
                  fill="none"
                  [attr.stroke-dasharray]="progressDasharray()"
                  [attr.stroke-dashoffset]="0"
                  [attr.transform]="'rotate(-90 ' + center + ' ' + center + ')'"
                  filter="url(#perfGlow)"
                  class="transition-all duration-700 ease-out"
                ></circle>
              </svg>

              <!-- center labels -->
              <div
                class="absolute inset-0 flex flex-col items-center justify-center"
              >
                <div
                  class="text-4xl font-extrabold text-slate-900 dark:text-slate-100"
                >
                  {{ avgPerf | number : "1.0-0" }}%
                </div>
                <div
                  class="mt-1 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400"
                >
                  {{ monthFrenchNames[currentMonth] }} {{ currentYear }}
                </div>
              </div>

              <!-- tiny status chip -->
              <div
                class="absolute -bottom-1.5 right-1 flex items-center gap-1 text-[11px]"
              >
                <span
                  class="inline-block h-2.5 w-2.5 rounded-full"
                  [ngStyle]="{ background: colorForPerf(avgPerf) }"
                ></span>
                <span class="text-slate-500 dark:text-slate-400"
                  >Score crédit</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="this.auth.isAdmin" class="container mx-auto p-4">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
        <!-- Montant Emprunter -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Montant Emprunter
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ loanAmount }}</strong>
          </p>
          <input
            [(ngModel)]="loanAmount"
            type="number"
            placeholder="Entrez le budget"
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="setClientField('loanAmount', loanAmount)"
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>

        <!-- Montant Restant -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Montant Restant
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ debtLeft }}</strong>
          </p>
          <input
            [(ngModel)]="debtLeft"
            type="number"
            placeholder=""
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="setClientField('debtLeft', debtLeft)"
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>

        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Montant A Payer
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ amountToPay }}</strong>
          </p>
          <input
            [(ngModel)]="amountToPay"
            type="number"
            placeholder=""
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="setClientField('amountToPay', amountToPay)"
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Montant Percu
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ amountPaid }}</strong>
          </p>
          <input
            [(ngModel)]="amountPaid"
            type="number"
            placeholder=""
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="setClientField('amountPaid', amountPaid)"
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>

        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Nombre Des Paiements Percu
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ numberOfPaymentsMade }}</strong>
          </p>
          <input
            [(ngModel)]="numberOfPaymentsMade"
            type="number"
            placeholder=""
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="
              setClientField('numberOfPaymentsMade', numberOfPaymentsMade)
            "
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Nombre Des Semaine Pour Payer
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ paymentPeriodRange }}</strong>
          </p>
          <input
            [(ngModel)]="paymentPeriodRange"
            type="number"
            placeholder=""
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="setClientField('paymentPeriodRange', paymentPeriodRange)"
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>

        <!-- Montant Restant -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Epargnes
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ debtLeft }}</strong>
          </p>
          <input
            [(ngModel)]="savings"
            type="number"
            placeholder=""
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="setClientField('savings', savings)"
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Score Credit
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ creditScore }}</strong>
          </p>
          <input
            [(ngModel)]="creditScore"
            type="number"
            placeholder=""
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="setClientField('creditScore', creditScore)"
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Is Phone Number Correct
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Valeur actuelle: <strong>{{ isPhoneNumberCorrect }}</strong>
          </p>
          <input
            [(ngModel)]="isPhoneNumberCorrect"
            type="text"
            placeholder=""
            class="w-full p-2.5 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
          />
          <button
            (click)="
              setClientField('isPhoneCorrect', isPhoneNumberCorrect, true)
            "
            class="w-full mt-2 py-2.5 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm"
          >
            Confirmer
          </button>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Étoiles (Stars)
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Nombre actuel: <strong>{{ stars }}</strong>
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">
            Nombre de fois que le client a été célébré pour ses accomplissements
          </p>
          <div class="flex items-center justify-center gap-4">
            <button
              (click)="adjustStars(-1)"
              type="button"
              class="flex items-center justify-center w-12 h-12 rounded-full bg-red-600 hover:bg-red-700 text-white font-bold text-xl shadow-lg transition hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300"
              title="Retirer une étoile"
            >
              −
            </button>
            <div class="text-3xl font-extrabold text-amber-500 dark:text-amber-400 min-w-[60px] text-center">
              {{ stars }}
            </div>
            <button
              (click)="adjustStars(1)"
              type="button"
              class="flex items-center justify-center w-12 h-12 rounded-full bg-green-600 hover:bg-green-700 text-white font-bold text-xl shadow-lg transition hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300"
              title="Ajouter une étoile"
            >
              +
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==== /END ==== -->

    <!-- ==== CLIENT TRANSFER SECTION (Admin Only) ==== -->
    <div
      *ngIf="auth.isAdmin"
      class="py-2 bg-gradient-to-br from-emerald-50 via-white to-teal-50 dark:from-slate-900 dark:via-slate-950 dark:to-slate-900/80"
    >
      <div class="max-w-5xl mx-auto px-4">
        <div
          class="rounded-2xl border border-slate-200/70 dark:border-slate-700 bg-white/90 dark:bg-slate-900/70 shadow-lg backdrop-blur"
        >
          <div class="px-6 pt-6 pb-4">
            <div class="flex items-center justify-between">
              <div class="space-y-1">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white">
                  Transférer un client vers une autre localisation
                </h2>
                <p class="text-sm text-slate-500 dark:text-slate-300">
                  Transférer un client d'une localisation à une autre. L'agent
                  associé ne sera pas transféré et devra être réassigné.
                </p>
              </div>
              <button
                type="button"
                (click)="toggleClientTransferSection()"
                class="flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium shadow transition focus:ring-4 focus:ring-emerald-300 dark:focus:ring-emerald-900"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
                {{
                  showClientTransferSection ? "Masquer" : "Afficher"
                }}
              </button>
            </div>
          </div>

          <div *ngIf="showClientTransferSection" class="px-6 pb-6 space-y-6">
            <!-- Success Message -->
            <div
              *ngIf="clientTransferSuccess"
              class="p-4 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 flex items-start gap-3"
            >
              <svg
                class="w-5 h-5 text-emerald-600 dark:text-emerald-300 flex-shrink-0 mt-0.5"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M5 13l4 4L19 7"
                />
              </svg>
              <div>
                <p class="font-semibold text-emerald-900 dark:text-emerald-200">
                  Client transféré avec succès !
                </p>
                <p class="text-sm text-emerald-700 dark:text-emerald-300 mt-1">
                  Le client a été transféré vers la nouvelle localisation.
                  L'agent devra être réassigné.
                </p>
              </div>
            </div>

            <!-- Error Message -->
            <div
              *ngIf="clientTransferError"
              class="p-4 rounded-lg bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 flex items-start gap-3"
            >
              <svg
                class="w-5 h-5 text-rose-600 dark:text-rose-300 flex-shrink-0 mt-0.5"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <div>
                <p class="font-semibold text-rose-900 dark:text-rose-200">
                  Erreur lors du transfert
                </p>
                <p class="text-sm text-rose-700 dark:text-rose-300 mt-1">
                  {{ clientTransferError }}
                </p>
              </div>
            </div>

            <!-- Current Client Info -->
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
              <div class="flex items-center gap-3">
                <div class="flex-shrink-0">
                  <div class="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                    <svg
                      class="w-6 h-6 text-emerald-600 dark:text-emerald-300"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                      />
                    </svg>
                  </div>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">
                    Client à transférer
                  </p>
                  <p class="text-lg font-semibold text-gray-900 dark:text-white">
                    {{ client.firstName }} {{ client.middleName }} {{ client.lastName }}
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    {{ client.phoneNumber }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Form -->
            <div>
              <!-- Target Location Selection -->
              <div>
                <label
                  class="block mb-2 text-sm font-semibold text-gray-800 dark:text-gray-200"
                >
                  Localisation de destination
                </label>
                <select
                  [(ngModel)]="selectedTargetLocationUserId"
                  [disabled]="clientTransferInProgress"
                  class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <option [ngValue]="null">
                    -- Sélectionnez une localisation --
                  </option>
                  <option *ngFor="let user of allUsers" [ngValue]="user.uid">
                    {{ user.firstName || user.lastName || user.email }}
                  </option>
                </select>
              </div>
            </div>

            <!-- Info Box -->
            <div
              class="p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800"
            >
              <div class="flex items-start gap-3">
                <svg
                  class="w-5 h-5 text-blue-600 dark:text-blue-300 flex-shrink-0 mt-0.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <div class="text-sm text-blue-800 dark:text-blue-200">
                  <p class="font-semibold mb-1">Note importante :</p>
                  <ul class="list-disc list-inside space-y-1 ml-2">
                    <li>
                      Toutes les informations du client seront transférées (nom,
                      téléphone, dette, épargnes, etc.)
                    </li>
                    <li>
                      L'agent associé <strong>ne sera pas</strong> transféré et
                      devra être réassigné à la nouvelle localisation
                    </li>
                    <li>
                      Le client original reste dans sa localisation d'origine
                    </li>
                    <li>
                      Un nouvel identifiant unique sera généré pour le client
                      transféré
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Action Button -->
            <div class="flex justify-end">
              <button
                type="button"
                (click)="copyClientToLocation()"
                [disabled]="
                  !selectedTargetLocationUserId ||
                  clientTransferInProgress ||
                  !client.uid
                "
                class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-6 py-3 text-sm font-medium text-white shadow transition hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-300 dark:focus:ring-emerald-900 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <svg
                  *ngIf="clientTransferInProgress"
                  class="w-4 h-4 animate-spin"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                <svg
                  *ngIf="!clientTransferInProgress"
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
                {{
                  clientTransferInProgress
                    ? "Transfert en cours..."
                    : "Transférer le client"
                }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ==== /CLIENT TRANSFER SECTION ==== -->

    <section class="bg-white dark:bg-gray-900 py-8 lg:py-16 antialiased">
      <div class="max-w-2xl mx-auto px-4">
        <div class="flex justify-between items-center mb-6">
          <h2
            class="text-lg lg:text-2xl font-bold text-gray-900 dark:text-white"
          >
            Commentaires...
          </h2>
        </div>
        <div class="mb-6">
          <div class="my-2">
            <label
              for="first_name"
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
              >Nom de la Person qui poste</label
            >
            <input
              [(ngModel)]="personPostingComment"
              type="text"
              id="first_name"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
              placeholder="Jeanne Kiluwa"
              required
            />
          </div>
          <div
            class="py-2 px-4 mb-4 bg-white rounded-lg rounded-t-lg border border-gray-200 dark:bg-gray-800 dark:border-gray-700"
          >
            <label for="comment" class="sr-only">Your comment</label>
            <textarea
              [(ngModel)]="comment"
              id="comment"
              rows="6"
              class="px-0 w-full text-sm text-gray-900 border-0 focus:ring-0 focus:outline-none dark:text-white dark:placeholder-gray-400 dark:bg-gray-800"
              placeholder="Les détails sur les raisons pour lesquelles le client ne paie pas..."
              required
            ></textarea>
          </div>
          <div class="flex flex-wrap gap-4 justify-center mb-4">
            <!-- Start Recording Button -->
            <button
              (click)="startRecording()"
              [disabled]="isRecording"
              class="flex items-center justify-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#1e90ff"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="mr-2"
              >
                <path
                  d="M12 1a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                ></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
              </svg>
              <span class="text-sm font-medium text-blue-700">Commencer </span>
            </button>

            <!-- Stop Recording Button -->
            <button
              (click)="stopRecording()"
              [disabled]="!isRecording"
              class="flex items-center justify-center p-3 bg-red-50 rounded-lg hover:bg-red-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#ff0000"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="mr-2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              <span class="text-sm font-medium text-red-700"> Arrêter </span>
            </button>

            <!-- Discard / Cancel Button -->
            <button
              (click)="discardAudio()"
              [disabled]="!recordedAudioURL && !selectedAudioPreviewURL"
              class="flex items-center justify-center p-3 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#ff4500"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="mr-2"
              >
                <path d="M3 6h18"></path>
                <path
                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4
                     a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                ></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
              <span class="text-sm font-medium text-orange-700">Annuler</span>
            </button>
          </div>

          <!-- Recording Progress and Timer -->
          <!-- Recording Progress and Timer -->
          <div *ngIf="isRecording" class="my-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm font-medium text-gray-700"
                >Enregistrement en cours...</span
              >
              <span class="text-sm font-medium text-gray-700">{{
                elapsedTime
              }}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
              <div
                class="bg-blue-600 h-2.5 rounded-full"
                [style.width.%]="getLimitedProgress()"
              ></div>
            </div>
          </div>

          <!-- for IOS -->
          <div *ngIf="selectedAudioPreviewURL" class="my-3">
            <p>Aperçu de votre fichier audio</p>
            <audio [src]="selectedAudioPreviewURL" controls></audio>
          </div>
          <!-- Audio Preview Section -->
          <div class="my-6" *ngIf="recordedAudioURL">
            <p class="text-sm font-medium text-gray-700 mb-2">
              Aperçu de votre enregistrement:
            </p>
            <div
              class="flex items-center justify-center p-4 bg-gray-50 rounded-lg border border-gray-200"
            >
              <audio
                [src]="recordedAudioURL"
                controls
                class="w-full max-w-md"
              ></audio>
            </div>
          </div>

          <!-- Audio File Upload Section -->
          <div class="my-6">
            <label
              for="audioFile"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Téléverser un fichier audio (optionnel)
            </label>
            <div class="flex items-center justify-center w-full">
              <label
                for="audioFile"
                class="flex flex-col items-center justify-center w-full h-32 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-100 transition-colors"
              >
                <div
                  class="flex flex-col items-center justify-center pt-5 pb-6"
                >
                  <!-- Microphone icon -->
                  <svg
                    class="w-8 h-8 mb-2 text-gray-500"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <!-- mic capsule -->
                    <rect x="9" y="2" width="6" height="12" rx="3"></rect>
                    <!-- arms -->
                    <path d="M5 10v2a7 7 0 0 0 14 0v-2"></path>
                    <!-- stand -->
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                  </svg>

                  <p class="text-sm text-center text-gray-500 px-4">
                    <span class="font-semibold"
                      >Cliquez pour ajouter un audio</span
                    >
                    ou glissez-déposez un fichier
                  </p>
                  <p class="text-xs text-gray-500">
                    Format supporté: audio (MP3, WAV, etc.)
                  </p>
                </div>

                <input
                  type="file"
                  id="audioFile"
                  accept=".m4a,.mp3,.wav,.aac,.caf,.aif,.aiff,.amr,.flac,.ogg,.webm,.3gp,.3gpp,audio/mp4,audio/x-m4a,audio/aac,audio/mpeg,audio/wav,audio/x-wav,audio/aiff,audio/x-aiff,audio/3gpp,audio/3gpp2,audio/amr,audio/flac,audio/ogg,audio/webm,audio/*"
                  (change)="onAudioFileSelected($any($event.target).files)"
                  class="hidden"
                />
              </label>
            </div>
          </div>

          <!-- Attach images / videos -->
          <div class="my-6 grid gap-4 md:grid-cols-2">
            <!-- Image picker -->
            <label
              for="imageFile"
              class="flex flex-col items-center justify-center w-full h-32 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-100 transition-colors"
            >
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <!-- Picture / Image icon -->
                <svg
                  class="w-8 h-8 mb-2 text-gray-500"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <!-- frame -->
                  <rect
                    x="3"
                    y="5"
                    width="18"
                    height="14"
                    rx="2"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                  <!-- sun -->
                  <circle cx="16" cy="10" r="2" fill="currentColor" />
                  <!-- mountains -->
                  <path
                    d="M7 17l3.8-3.8a1 1 0 0 1 1.4 0L15 16l2-2 3 3H7z"
                    fill="currentColor"
                  />
                </svg>

                <p class="text-sm text-gray-500">
                  <span class="font-semibold">Ajouter une image</span> (JPG,
                  PNG, HEIC…)
                </p>
                <p class="text-xs text-gray-500">Max 10&nbsp;MB</p>
              </div>

              <input
                id="imageFile"
                type="file"
                accept="image/*"
                (change)="onImageSelected($any($event.target).files)"
                class="hidden"
              />
            </label>

            <!-- Video picker -->
            <label
              for="videoFile"
              class="flex flex-col items-center justify-center w-full h-32 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-100 transition-colors"
            >
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <svg
                  class="w-8 h-8 mb-2 text-gray-500"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <rect
                    x="3"
                    y="6"
                    width="12"
                    height="12"
                    rx="2"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
                <p class="text-sm text-gray-500">
                  <span class="font-semibold">Ajouter une vidéo</span> (MP4,
                  MOV…)
                </p>
                <p class="text-xs text-gray-500">Max 100&nbsp;MB</p>
              </div>
              <input
                id="videoFile"
                type="file"
                accept="video/*"
                (change)="onVideoSelected($any($event.target).files)"
                class="hidden"
              />
            </label>
          </div>

          <!-- Image preview + exact capture time -->
          <div
            *ngIf="selectedImagePreviewURL"
            class="my-3 rounded-lg border p-3 bg-gray-50"
          >
            <div class="flex items-start gap-4">
              <img
                [src]="selectedImagePreviewURL"
                class="h-24 w-24 object-cover rounded-lg shadow"
              />
              <div class="text-sm text-gray-700">
                <div *ngIf="imageCaptureTimeISO">
                  <strong>Prise le&nbsp;:</strong>
                  {{ formatISOToDRC(imageCaptureTimeISO) }}
                  <span class="text-gray-400"
                    >({{ imageCaptureTimeSource }})</span
                  >
                </div>
                <div *ngIf="imageMetaWH?.width">
                  <strong>Taille&nbsp;:</strong> {{ imageMetaWH?.width }}×{{
                    imageMetaWH?.height
                  }}
                  px
                </div>
                <div *ngIf="imageGPS">
                  <strong>GPS&nbsp;:</strong> {{ imageGPS.lat }},
                  {{ imageGPS.lng }}
                </div>
                <button
                  type="button"
                  (click)="clearSelectedImage()"
                  class="mt-2 inline-flex items-center rounded-full bg-orange-50 px-3 py-1 text-xs font-medium text-orange-700 ring-1 ring-orange-200"
                >
                  Retirer l’image
                </button>
              </div>
            </div>
          </div>

          <!-- Video preview + exact capture time -->
          <div
            *ngIf="selectedVideoPreviewURL"
            class="my-3 rounded-lg border p-3 bg-gray-50"
          >
            <div class="flex flex-col gap-2">
              <video
                [src]="selectedVideoPreviewURL"
                controls
                class="w-full max-w-md rounded-lg shadow"
              ></video>
              <div class="text-sm text-gray-700">
                <div *ngIf="videoCaptureTimeISO">
                  <strong>Filmé le&nbsp;:</strong>
                  {{ formatISOToDRC(videoCaptureTimeISO) }}
                  <span class="text-gray-400"
                    >({{ videoCaptureTimeSource }})</span
                  >
                </div>
                <div *ngIf="videoMeta?.width">
                  <strong>Taille&nbsp;:</strong> {{ videoMeta!.width }}×{{
                    videoMeta!.height
                  }}
                  px
                </div>
                <div *ngIf="videoMeta?.durationSec">
                  <strong>Durée&nbsp;:</strong>
                  {{ videoMeta!.durationSec | number : "1.0-0" }} s
                </div>
                <button
                  type="button"
                  (click)="clearSelectedVideo()"
                  class="mt-2 inline-flex items-center rounded-full bg-orange-50 px-3 py-1 text-xs font-medium text-orange-700 ring-1 ring-orange-200"
                >
                  Retirer la vidéo
                </button>
              </div>
            </div>
          </div>

          <button
            (click)="addCommentWithAudioFile()"
            type="button"
            class="inline-flex items-center gap-2 py-2.5 px-4 text-xs font-medium text-white bg-green-700 rounded-lg focus:ring-4 focus:ring-green-200 dark:focus:ring-green-900 hover:bg-green-800 disabled:opacity-60 disabled:cursor-not-allowed"
            [disabled]="isPosting"
            aria-live="polite"
          >
            <!-- spinner while posting -->
            <svg
              *ngIf="isPosting"
              class="h-4 w-4 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                d="M4 12a8 8 0 018-8"
                stroke="currentColor"
                stroke-width="4"
                stroke-linecap="round"
              ></path>
            </svg>
            <span>{{ isPosting ? "Envoi…" : "Poster commentaire" }}</span>
          </button>
        </div>
        <!--  modern block-quote style for each comment  -->
        <article
          *ngFor="
            let c of comments
              | slice : 0 : (auth.isAdmin ? comments.length : 2);
            let i = index
          "
          class="relative mx-auto mb-6 max-w-2xl rounded-3xl bg-white shadow-lg dark:bg-gray-800"
        >
          <!-- decorative left ribbon  -->
          <span
            class="absolute inset-y-0 left-0 w-1 rounded-l-3xl bg-gradient-to-b from-green-400 to-green-600"
          ></span>

          <header class="flex items-center px-6 pt-5">
            <!-- avatar -->
            <div
              class="mr-3 flex h-10 w-10 items-center justify-center overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700"
            >
              <span class="font-medium text-gray-600 dark:text-gray-300">
                {{ c.name?.substring(0, 2) }}
              </span>
            </div>

            <!-- name & date -->
            <div class="flex flex-col">
              <p class="text-sm font-semibold text-gray-900 dark:text-white">
                {{ c.name }}
              </p>
              <time
                [attr.datetime]="c['timeISO'] ?? ''"
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                {{ c.timeFormatted }}
              </time>
            </div>
          </header>

          <!-- comment body -->
          <blockquote
            class="relative mt-4 rounded-b-3xl bg-gray-50 px-6 pb-6 pt-4 italic text-gray-800 dark:bg-gray-900 dark:text-gray-200"
          >
            <!-- quotation mark decoration -->
            <svg
              aria-hidden="true"
              class="absolute left-3 top-3 h-5 w-5 text-green-400 opacity-30"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M7.17 15H4.31c.4-2.78 1.5-5.71 3.3-8.79L10 7.4c-1.27 2.08-2.01 4.15-2.21 6.21.46-.39 1.02-.59 1.68-.59.83 0 1.49.28 1.97.83.48.55.72 1.31.72 2.27 0 .92-.29 1.68-.86 2.28-.58.61-1.37.91-2.37.91-1.01 0-1.82-.31-2.44-.93-.62-.61-.93-1.45-.93-2.53 0-.71.1-1.39.3-2.04h.01zm9 0h-2.86c.4-2.78 1.5-5.71 3.3-8.79L19 7.4c-1.27 2.08-2.01 4.15-2.21 6.21.46-.39 1.02-.59 1.68-.59.83 0 1.49.28 1.97.83.48.55.72 1.31.72 2.27 0 .92-.29 1.68-.86 2.28-.58.61-1.37.91-2.37.91-1.01 0-1.82-.31-2.44-.93-.62-.61-.93-1.45-.93-2.53 0-.71.1-1.39.3-2.04h.01z"
              />
            </svg>

            <p class="ml-6 leading-relaxed" *ngIf="c.comment">
              {{ c.comment }}
            </p>

            <!-- audio (if any) -->
            <div *ngIf="c.audioUrl" class="mt-4 ml-6">
              <audio
                [src]="c.audioUrl"
                controls
                class="w-full max-w-sm rounded-lg shadow dark:bg-gray-700"
              ></audio>
              <div
                *ngIf="c['audioMeta']?.captureTimeOriginalISO"
                class="mt-1 text-xs text-gray-600 dark:text-gray-400"
              >
                Enregistré le&nbsp;{{
                  formatISOToDRC(c["audioMeta"].captureTimeOriginalISO)
                }}
                <span
                  *ngIf="c['audioMeta']?.captureTimeSource"
                  class="text-gray-400"
                >
                  ({{ c["audioMeta"].captureTimeSource }})
                </span>
                <span *ngIf="c['audioMeta']?.durationSec"
                  >&nbsp;•&nbsp;{{
                    c["audioMeta"].durationSec | number : "1.0-0"
                  }}
                  s</span
                >
              </div>
            </div>

            <!-- attachments (images / videos) -->
            <div *ngIf="c.attachments?.length" class="mt-4 ml-6 grid gap-4">
              <ng-container *ngFor="let att of c.attachments">
                <!-- image -->
                <figure
                  *ngIf="att.type === 'image'"
                  class="rounded-lg overflow-hidden"
                >
                  <img
                    [src]="att.url"
                    class="max-h-64 rounded-lg shadow object-contain"
                  />
                  <figcaption
                    class="mt-2 text-xs text-gray-600 dark:text-gray-400"
                  >
                    Prise le&nbsp;
                    <span *ngIf="att.captureTimeOriginalISO">{{
                      formatISOToDRC(att.captureTimeOriginalISO)
                    }}</span>
                    <span *ngIf="!att.captureTimeOriginalISO">—</span>
                    <span class="text-gray-400" *ngIf="att.captureTimeSource"
                      >&nbsp;({{ att.captureTimeSource }})</span
                    >
                  </figcaption>
                </figure>

                <!-- video -->
                <figure
                  *ngIf="att.type === 'video'"
                  class="rounded-lg overflow-hidden"
                >
                  <video
                    [src]="att.url"
                    controls
                    class="w-full max-w-lg rounded-lg shadow"
                  ></video>
                  <figcaption
                    class="mt-2 text-xs text-gray-600 dark:text-gray-400"
                  >
                    Filmé le&nbsp;
                    <span *ngIf="att.captureTimeOriginalISO">{{
                      formatISOToDRC(att.captureTimeOriginalISO)
                    }}</span>
                    <span *ngIf="!att.captureTimeOriginalISO">—</span>
                    <span class="text-gray-400" *ngIf="att.captureTimeSource"
                      >&nbsp;({{ att.captureTimeSource }})</span
                    >
                    <span *ngIf="att.durationSec"
                      >&nbsp;•&nbsp;{{
                        att.durationSec | number : "1.0-0"
                      }}
                      s</span
                    >
                  </figcaption>
                </figure>
              </ng-container>
            </div>
          </blockquote>
        </article>
      </div>
    </section>

    <!-- Posting overlay -->
    <div
      *ngIf="isPosting"
      class="fixed inset-0 z-50 grid place-items-center bg-black/40 backdrop-blur-sm"
    >
      <div
        class="flex items-center gap-3 rounded-2xl bg-white/90 dark:bg-slate-900/80 px-5 py-3 shadow-2xl ring-1 ring-black/10 dark:ring-white/10"
      >
        <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none">
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            d="M4 12a8 8 0 018-8"
            stroke="currentColor"
            stroke-width="4"
            stroke-linecap="round"
          ></path>
        </svg>
        <span class="text-sm font-medium text-slate-700 dark:text-slate-200"
          >Envoi du commentaire…</span
        >
      </div>
    </div>
  </div>
</div>
